<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - FullGaming</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo_solo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <!-- MODAL DE CONFIRMACI√ìN -->
    <div id="modal-confirmacion" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <h2 class="modal-title">Eliminar Direcci√≥n</h2>
            <p class="modal-description">¬øEst√°s seguro de que deseas eliminar esta direcci√≥n? Esta acci√≥n no se puede deshacer.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmarEliminacion()">Eliminar</button>
            </div>
        </div>
    </div>

    <div class="container-fluid perfil-container">
        <!-- BOT√ìN VOLVER ATR√ÅS -->
        <div class="perfil-volver">
            <a href="/" onclick="history.back()" class="volver-btn">
                <span class="icon">‚Üê</span>
                <span>Volver</span>
            </a>
        </div>

        <div class="perfil-header">
            <h1 class="perfil-logo">FULLGAMING</h1>
            <p class="perfil-subtitle">Centro de Comandos</p>
        </div>

        <div class="perfil-content-wrapper">
            <div class="perfil-content">
                <!-- SIDEBAR -->
                <div class="perfil-sidebar">
                    <div class="perfil-card perfil-usuario">
                        <div class="avatar-perfil">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </div>
                        <h3 class="perfil-nombre">{{ usuario_nombre }}</h3>
                        <p class="perfil-email">{{ usuario_email }}</p>
                    </div>

                    <nav class="perfil-nav">
                        <a href="javascript:void(0)" class="perfil-nav-item active" onclick="cambiarSeccion('resumen'); return false;">
                            <span class="icon">üìä</span>
                            <span>Resumen</span>
                        </a>
                        <a href="javascript:void(0)" class="perfil-nav-item" onclick="cambiarSeccion('direcciones'); return false;">
                            <span class="icon">üìç</span>
                            <span>Direcciones</span>
                        </a>
                        <a href="javascript:void(0)" class="perfil-nav-item" onclick="cambiarSeccion('cuenta'); return false;">
                            <span class="icon">‚öôÔ∏è</span>
                            <span>Mi Cuenta</span>
                        </a>
                        <a href="/logout" class="perfil-nav-item logout">
                            <span class="icon">üö™</span>
                            <span>Cerrar sesi√≥n</span>
                        </a>
                    </nav>

                    <!-- Direcci√≥n Principal -->
                    <div class="perfil-card">
                        <h4 style="margin-bottom: 15px;">Direcci√≥n Principal</h4>
                        <div id="direccion-info" class="sin-direccion-sidebar">
                            <p>üìç No tienes una direcci√≥n registrada</p>
                            <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')">
                                Agregar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CONTENIDO PRINCIPAL -->
                <div class="perfil-main">
                    <!-- CARDS SUPERIORES: Pedidos e Informaci√≥n -->
                    <div class="perfil-top-cards">
                        <!-- Pedidos Recientes -->
                        <div>
                            <div class="perfil-card">
                                <h4>Pedidos Recientes</h4>
                                <div class="pedidos-container">
                                    {% if pedidos_recientes|length > 0 %}
                                        <table class="table table-dark table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Pedido</th>
                                                    <th>Fecha</th>
                                                    <th>Total</th>
                                                    <th>Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for pedido in pedidos_recientes %}
                                                <tr>
                                                    <td>#{{ pedido.id }}</td>
                                                    <td>{{ pedido.fecha }}</td>
                                                    <td>${{ "%d" | format(pedido.total) }}</td>
                                                    <td><span class="badge bg-info">{{ pedido.estado }}</span></td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    {% else %}
                                        <div class="sin-pedidos">
                                            <p>üõçÔ∏è No tienes pedidos a√∫n</p>
                                            <a href="/" class="btn btn-sm" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none;">
                                                Explorar Productos
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n de Cuenta -->
                        <div>
                            <div class="perfil-card">
                                <div class="card-header-perfil">
                                    <h4>Informaci√≥n de Cuenta</h4>
                                    <a href="javascript:void(0)" class="editar-btn" onclick="cambiarSeccion('cuenta')">Editar</a>
                                </div>
                                <div id="info-cuenta" class="info-cuenta">
                                    <div class="info-item">
                                        <label>Nombre</label>
                                        <p>{{ usuario_nombre }}</p>
                                    </div>
                                    <div class="info-item">
                                        <label>Email</label>
                                        <p>{{ usuario_email }}</p>
                                    </div>
                                    <div class="info-item">
                                        <label>Tel√©fono</label>
                                        <p id="info-telefono">{{ usuario_telefono if usuario_telefono else 'üì± No proporcionado' }}</p>
                                    </div>
                                    <div class="info-item">
                                        <label>DNI</label>
                                        <p id="info-dni">{{ usuario_dni if usuario_dni else 'üÜî No proporcionado' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN RESUMEN -->
                    <div id="seccion-resumen" class="perfil-section active">
                    </div>

                    <!-- SECCI√ìN DIRECCIONES -->
                    <div id="seccion-direcciones" class="perfil-section">
                        <div class="perfil-card">
                            <div class="card-header-perfil">
                                <h4>Mis Direcciones</h4>
                                <button type="button" class="btn btn-sm" onclick="toggleFormularioDireccion()" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none;">
                                    + Agregar Direcci√≥n
                                </button>
                            </div>

                            <!-- Formulario para agregar direcci√≥n -->
                            <div id="formulario-direccion" style="display: none; margin-bottom: 30px;">
                                <form onsubmit="guardarDireccion(event)">
                                    <div class="mb-3">
                                        <label>Provincia</label>
                                        <select name="provincia" class="form-control" required>
                                            <option value="">Selecciona provincia</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label>Municipio</label>
                                        <select name="municipio" class="form-control" required>
                                            <option value="">Selecciona municipio</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label>Calle</label>
                                        <input type="text" name="calle" class="form-control" placeholder="Ej: Avenida 9 de Julio" required>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>N√∫mero</label>
                                            <input type="text" name="numero" class="form-control" placeholder="Ej: 1234" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Piso/Departamento (opcional)</label>
                                            <input type="text" name="piso_departamento" class="form-control" placeholder="Ej: 5to piso, Depto A">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>C√≥digo Postal</label>
                                        <input type="text" name="codigo_postal" class="form-control" placeholder="Ej: 1425" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label style="display: flex; align-items: center; gap: 10px;">
                                            <input type="checkbox" name="es_principal">
                                            Marcar como direcci√≥n principal
                                        </label>
                                    </div>
                                    <div class="button-group">
                                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none;">
                                            Guardar Direcci√≥n
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="toggleFormularioDireccion()">
                                            Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Lista de direcciones -->
                            <div class="direcciones-list" id="lista-direcciones">
                                <div class="sin-direccion">
                                    <p>üìç No tienes direcciones guardadas</p>
                                    <p class="texto-gris">Las direcciones te ayudar√°n a completar compras m√°s r√°pido</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN CUENTA -->
                    <div id="seccion-cuenta" class="perfil-section">
                        <div class="perfil-card">
                            <h4 style="margin-bottom: 30px;">Editar Informaci√≥n de Cuenta</h4>
                            <form id="form-cuenta" onsubmit="guardarCuenta(event)">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label>Nombre</label>
                                        <input type="text" name="nombre" class="form-control" value="{{ usuario_nombre }}" placeholder="Tu nombre" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>Email</label>
                                        <input type="email" name="email" class="form-control" value="{{ usuario_email }}" placeholder="Tu email" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label>Tel√©fono</label>
                                        <input type="tel" name="telefono" class="form-control" placeholder="+54 9 11 2345-6789" value="{{ usuario_telefono if usuario_telefono else '' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>DNI</label>
                                        <input type="text" name="dni" class="form-control" placeholder="Ej: 12345678" value="{{ usuario_dni if usuario_dni else '' }}">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label>Nueva Contrase√±a (opcional)</label>
                                    <input type="password" name="contrase√±a_nueva" class="form-control" placeholder="Dejar en blanco para no cambiar">
                                </div>
                                <div class="button-group">
                                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none;">
                                        Guardar Cambios
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="cambiarSeccion('resumen')">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ UTILIDADES ============
        function mostrarNotificacion(mensaje, esError = false) {
            const notif = document.createElement('div');
            notif.className = 'notificacion' + (esError ? ' error' : '');
            notif.textContent = mensaje;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function cambiarSeccion(seccion) {
            console.log('Cambiando a secci√≥n:', seccion);
            
            document.querySelectorAll('.perfil-section').forEach(s => {
                s.classList.remove('active');
            });
            document.querySelectorAll('.perfil-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const sectionEl = document.getElementById(`seccion-${seccion}`);
            if (sectionEl) {
                sectionEl.classList.add('active');
            }

            // Marcar nav como activo
            const navItems = document.querySelectorAll('.perfil-nav-item');
            if (seccion === 'resumen') {
                navItems[0]?.classList.add('active');
            } else if (seccion === 'direcciones') {
                navItems[1]?.classList.add('active');
                cargarDirecciones();
                cargarDireccionPrincipal();
                cargarProvincias();
            } else if (seccion === 'cuenta') {
                navItems[2]?.classList.add('active');
            }
        }

        // ============ PERFIL - ACTUALIZAR DATOS ============
        function guardarCuenta(event) {
            event.preventDefault();

            const nombre = document.querySelector('input[name="nombre"]').value.trim();
            const email = document.querySelector('input[name="email"]').value.trim();
            const telefono = document.querySelector('input[name="telefono"]').value.trim();
            const dni = document.querySelector('input[name="dni"]').value.trim();

            if (!nombre || !email) {
                mostrarNotificacion('‚ùå Nombre y email son obligatorios', true);
                return;
            }

            // Dividir nombre en nombre y apellido
            const partes = nombre.split(' ');
            const nombreParte = partes[0];
            const apellidoParte = partes.slice(1).join(' ') || '';

            const datos = {
                nombre: nombreParte,
                apellido: apellidoParte,
                email: email,
                telefono: telefono,
                dni: dni
            };

            fetch('/api/perfil/actualizar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    mostrarNotificacion('‚úì Perfil actualizado correctamente');
                    // Actualizar el tel√©fono en la informaci√≥n de cuenta
                    const infoBailoTelefono = document.getElementById('info-telefono');
                    if (infoBailoTelefono) {
                        infoBailoTelefono.textContent = telefono || 'üì± No proporcionado';
                    }
                    // Actualizar el DNI en la informaci√≥n de cuenta
                    const infoDni = document.getElementById('info-dni');
                    if (infoDni) {
                        infoDni.textContent = dni || 'üÜî No proporcionado';
                    }
                    setTimeout(() => location.reload(), 1500);
                } else {
                    mostrarNotificacion('‚ùå ' + (data.error || 'Error al actualizar'), true);
                }
            })
            .catch(err => {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            });
        }

        // ============ DIRECCIONES - TOGGLE FORMULARIO ============
        function toggleFormularioDireccion() {
            const formulario = document.getElementById('formulario-direccion');
            if (formulario) {
                formulario.style.display = formulario.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ============ DIRECCIONES - GUARDAR ============
        function guardarDireccion(event) {
            event.preventDefault();

            const form = event.target;
            const datos = {
                provincia: form.querySelector('select[name="provincia"]').value,
                municipio: form.querySelector('select[name="municipio"]').value,
                calle: form.querySelector('input[name="calle"]').value,
                numero: form.querySelector('input[name="numero"]').value,
                piso_departamento: form.querySelector('input[name="piso_departamento"]').value,
                codigo_postal: form.querySelector('input[name="codigo_postal"]').value,
                es_principal: form.querySelector('input[name="es_principal"]').checked
            };

            if (!datos.provincia || !datos.municipio || !datos.calle || !datos.numero) {
                mostrarNotificacion('‚ùå Completa todos los campos obligatorios', true);
                return;
            }

            fetch('/api/direcciones/crear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    mostrarNotificacion('‚úì Direcci√≥n guardada correctamente');
                    form.reset();
                    toggleFormularioDireccion();
                    cargarDirecciones();
                    cargarDireccionPrincipal();
                } else {
                    mostrarNotificacion('‚ùå ' + (data.error || 'Error al guardar'), true);
                }
            })
            .catch(err => {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            });
        }

        // ============ DIRECCIONES - CARGAR LISTA ============
        async function cargarDirecciones() {
            try {
                const res = await fetch('/api/direcciones');
                const data = await res.json();
                
                const listaDirecciones = document.getElementById('lista-direcciones');
                if (!listaDirecciones) return;

                if (data.ok && data.direcciones && data.direcciones.length > 0) {
                    listaDirecciones.innerHTML = data.direcciones.map(dir => `
                        <div class="perfil-card" style="margin-bottom: 15px; position: relative;">
                            ${dir.es_principal ? '<div style="position: absolute; top: 10px; right: 10px; background: #FFD700; color: #333; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold;">‚≠ê Principal</div>' : ''}
                            <div class="card-header-perfil" style="align-items: flex-start; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 8px 0;">${dir.calle} ${dir.numero}</h5>
                                    ${dir.piso_departamento ? `<p style="margin: 0 0 8px 0; color: #999; font-size: 14px;">${dir.piso_departamento}</p>` : ''}
                                    <p style="margin: 0;">üìç ${dir.municipio}, ${dir.provincia}</p>
                                    <p style="margin: 5px 0; color: #999; font-size: 13px;">CP: ${dir.codigo_postal}</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${!dir.es_principal ? `<button type="button" onclick="establecerPrincipal(${dir.id})" class="btn btn-sm" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none; flex: 1;">‚≠ê Hacer Principal</button>` : ''}
                                <button type="button" onclick="editarDireccion(${dir.id})" class="btn btn-sm" style="background: #3498db; color: white; border: none; flex: 1;">‚úèÔ∏è Editar</button>
                                <button type="button" onclick="eliminarDireccion(${dir.id})" class="btn btn-sm" style="background: #e74c3c; color: white; border: none; flex: 1;">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listaDirecciones.innerHTML = `
                        <div class="sin-direccion">
                            <p>üìç No tienes direcciones guardadas</p>
                            <p class="texto-gris">Las direcciones te ayudar√°n a completar compras m√°s r√°pido</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error cargando direcciones:', err);
            }
        }

        // ============ CARGAR DIRECCI√ìN PRINCIPAL EN SIDEBAR ============
        async function cargarDireccionPrincipal() {
            try {
                const res = await fetch('/api/direcciones');
                const data = await res.json();
                
                const direccionInfo = document.getElementById('direccion-info');
                if (!direccionInfo) return;

                if (data.ok && data.direcciones && data.direcciones.length > 0) {
                    // Buscar la direcci√≥n principal
                    const direccionPrincipal = data.direcciones.find(dir => dir.es_principal);
                    
                    if (direccionPrincipal) {
                        // Mostrar direcci√≥n principal
                        direccionInfo.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <p style="font-weight: bold; margin-bottom: 5px;">‚≠ê ${direccionPrincipal.calle} ${direccionPrincipal.numero}</p>
                                ${direccionPrincipal.piso_departamento ? `<p style="margin: 3px 0; font-size: 0.9em;">${direccionPrincipal.piso_departamento}</p>` : ''}
                                <p style="margin: 3px 0; color: #999;">${direccionPrincipal.municipio}, ${direccionPrincipal.provincia}</p>
                                <p style="margin: 3px 0; color: #999; font-size: 0.85em;">CP: ${direccionPrincipal.codigo_postal}</p>
                            </div>
                            <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')" style="width: 100%; margin-top: 10px;">
                                Editar
                            </button>
                        `;
                    } else if (data.direcciones.length > 0) {
                        // Hay direcciones pero ninguna es principal, mostrar la primera
                        const dir = data.direcciones[0];
                        direccionInfo.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <p style="font-weight: bold; margin-bottom: 5px;">${dir.calle} ${dir.numero}</p>
                                ${dir.piso_departamento ? `<p style="margin: 3px 0; font-size: 0.9em;">${dir.piso_departamento}</p>` : ''}
                                <p style="margin: 3px 0; color: #999;">${dir.municipio}, ${dir.provincia}</p>
                                <p style="margin: 3px 0; color: #999; font-size: 0.85em;">CP: ${dir.codigo_postal}</p>
                            </div>
                            <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')" style="width: 100%; margin-top: 10px;">
                                Editar
                            </button>
                        `;
                    } else {
                        // No hay direcciones
                        direccionInfo.innerHTML = `
                            <p>üìç No tienes una direcci√≥n registrada</p>
                            <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')">
                                Agregar
                            </button>
                        `;
                    }
                } else {
                    // Error o sin direcciones
                    direccionInfo.innerHTML = `
                        <p>üìç No tienes una direcci√≥n registrada</p>
                        <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')">
                            Agregar
                        </button>
                    `;
                }
            } catch (err) {
                console.error('Error cargando direcci√≥n principal:', err);
            }
        }

        // ============ MODAL DE CONFIRMACI√ìN ============
        let direccionAEliminar = null;

        function abrirModalEliminar(id) {
            direccionAEliminar = id;
            const modal = document.getElementById('modal-confirmacion');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function cerrarModal() {
            const modal = document.getElementById('modal-confirmacion');
            if (modal) {
                modal.classList.remove('active');
            }
            direccionAEliminar = null;
        }

        function confirmarEliminacion() {
            if (direccionAEliminar === null) return;

            const id = direccionAEliminar;
            cerrarModal();

            fetch(`/api/direcciones/${id}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    mostrarNotificacion('‚úì Direcci√≥n eliminada');
                    cargarDirecciones();
                    cargarDireccionPrincipal();
                } else {
                    mostrarNotificacion('‚ùå Error al eliminar', true);
                }
            })
            .catch(err => {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            });
        }

        // ============ DIRECCIONES - ELIMINAR ============
        function eliminarDireccion(id) {
            abrirModalEliminar(id);
        }

        // ============ ESTABLECER DIRECCI√ìN COMO PRINCIPAL ============
        function establecerPrincipal(id) {
            fetch(`/api/direcciones/${id}/principal`, {
                method: 'PUT'
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    mostrarNotificacion('‚úì Direcci√≥n establecida como principal');
                    cargarDirecciones();
                    cargarDireccionPrincipal();
                } else {
                    mostrarNotificacion('‚ùå Error al cambiar direcci√≥n principal', true);
                }
            })
            .catch(err => {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            });
        }

        // ============ EDITAR DIRECCI√ìN ============
        async function editarDireccion(id) {
            try {
                // Cargar datos de la direcci√≥n
                const res = await fetch(`/api/direcciones/${id}`);
                const data = await res.json();

                if (data.ok && data.direccion) {
                    const dir = data.direccion;
                    
                    // Llenar el formulario con los datos actuales
                    document.querySelector('select[name="provincia"]').value = dir.provincia;
                    
                    // Cargar municipios
                    await cargarMunicipiosEdicion(dir.provincia);
                    document.querySelector('select[name="municipio"]').value = dir.municipio;
                    
                    // Llenar otros campos
                    document.querySelector('input[name="calle"]').value = dir.calle;
                    document.querySelector('input[name="numero"]').value = dir.numero;
                    document.querySelector('input[name="piso_departamento"]').value = dir.piso_departamento || '';
                    
                    // Cargar c√≥digo postal
                    const inputCP = document.querySelector('input[name="codigo_postal"]');
                    if (inputCP) {
                        inputCP.value = dir.codigo_postal;
                    }
                    
                    document.querySelector('input[name="es_principal"]').checked = dir.es_principal;
                    
                    // Cambiar el formulario para edici√≥n
                    const formulario = document.getElementById('formulario-direccion');
                    if (formulario) {
                        formulario.style.display = 'block';
                        formulario.onsubmit = (event) => guardarEdicionDireccion(event, id);
                        
                        // Cambiar el bot√≥n
                        const btnSubmit = formulario.querySelector('button[type="submit"]');
                        if (btnSubmit) {
                            btnSubmit.textContent = 'Guardar Cambios';
                        }
                    }
                    
                    // Desplazarse al formulario
                    cambiarSeccion('direcciones');
                    setTimeout(() => {
                        formulario.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                } else {
                    mostrarNotificacion('‚ùå Error al cargar direcci√≥n', true);
                }
            } catch (err) {
                mostrarNotificacion('‚ùå Error al cargar direcci√≥n', true);
                console.error(err);
            }
        }

        // Cargar municipios para edici√≥n
        async function cargarMunicipiosEdicion(provincia) {
            try {
                const res = await fetch(`/api/municipios/${encodeURIComponent(provincia)}`);
                const data = await res.json();
                
                if (data.ok && data.municipios) {
                    const selectMunicipio = document.querySelector('select[name="municipio"]');
                    if (selectMunicipio) {
                        selectMunicipio.innerHTML = '<option value="">Selecciona municipio</option>';
                        data.municipios.forEach(m => {
                            const option = document.createElement('option');
                            option.value = m;
                            option.textContent = m;
                            selectMunicipio.appendChild(option);
                        });
                    }
                }
            } catch (err) {
                console.error('Error cargando municipios:', err);
            }
        }

        // ============ GUARDAR EDICI√ìN DE DIRECCI√ìN ============
        function guardarEdicionDireccion(event, id) {
            event.preventDefault();

            const form = event.target;
            const datos = {
                provincia: form.querySelector('select[name="provincia"]').value,
                municipio: form.querySelector('select[name="municipio"]').value,
                calle: form.querySelector('input[name="calle"]').value,
                numero: form.querySelector('input[name="numero"]').value,
                piso_departamento: form.querySelector('input[name="piso_departamento"]').value,
                codigo_postal: form.querySelector('input[name="codigo_postal"]').value,
                es_principal: form.querySelector('input[name="es_principal"]').checked
            };

            if (!datos.provincia || !datos.municipio || !datos.calle || !datos.numero) {
                mostrarNotificacion('‚ùå Completa todos los campos obligatorios', true);
                return;
            }

            fetch(`/api/direcciones/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    mostrarNotificacion('‚úì Direcci√≥n actualizada correctamente');
                    form.reset();
                    toggleFormularioDireccion();
                    
                    // Restaurar bot√≥n
                    const btnSubmit = form.querySelector('button[type="submit"]');
                    if (btnSubmit) {
                        btnSubmit.textContent = 'Guardar Direcci√≥n';
                    }
                    form.onsubmit = (event) => guardarDireccion(event);
                    
                    cargarDirecciones();
                    cargarDireccionPrincipal();
                } else {
                    mostrarNotificacion('‚ùå ' + (data.error || 'Error al guardar'), true);
                }
            })
            .catch(err => {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            });
        }

        // ============ DIRECCIONES - CARGAR PROVINCIAS ============
        async function cargarProvincias() {
            try {
                const res = await fetch('/api/provincias');
                const data = await res.json();
                
                if (data.ok && data.provincias) {
                    const selectProvincia = document.querySelector('select[name="provincia"]');
                    if (selectProvincia && selectProvincia.options.length === 1) {
                        data.provincias.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p;
                            option.textContent = p;
                            selectProvincia.appendChild(option);
                        });
                        selectProvincia.addEventListener('change', cargarMunicipios);
                    }
                }
            } catch (err) {
                console.error('Error cargando provincias:', err);
            }
        }

        // ============ DIRECCIONES - CARGAR MUNICIPIOS ============
        async function cargarMunicipios(event) {
            const provincia = event.target.value;
            if (!provincia) return;

            try {
                const res = await fetch(`/api/municipios/${encodeURIComponent(provincia)}`);
                const data = await res.json();
                
                if (data.ok && data.municipios) {
                    const selectMunicipio = document.querySelector('select[name="municipio"]');
                    if (selectMunicipio) {
                        selectMunicipio.innerHTML = '<option value="">Selecciona municipio</option>';
                        data.municipios.forEach(m => {
                            const option = document.createElement('option');
                            option.value = m;
                            option.textContent = m;
                            selectMunicipio.appendChild(option);
                        });
                        selectMunicipio.addEventListener('change', cargarCodigoPostal);
                    }
                }
            } catch (err) {
                console.error('Error cargando municipios:', err);
            }
        }

        // ============ DIRECCIONES - CARGAR C√ìDIGO POSTAL ============
        async function cargarCodigoPostal(event) {
            const provincia = document.querySelector('select[name="provincia"]').value;
            const municipio = event.target.value;

            if (!provincia || !municipio) return;

            try {
                const res = await fetch(`/api/codigo-postal/${encodeURIComponent(provincia)}/${encodeURIComponent(municipio)}`);
                const data = await res.json();
                
                const inputCodigoPostal = document.querySelector('input[name="codigo_postal"]');
                if (inputCodigoPostal && data.ok) {
                    inputCodigoPostal.value = data.codigo_postal;
                } else if (inputCodigoPostal) {
                    inputCodigoPostal.value = municipio;
                }
            } catch (err) {
                console.error('Error cargando c√≥digo postal:', err);
                const inputCodigoPostal = document.querySelector('input[name="codigo_postal"]');
                if (inputCodigoPostal) {
                    inputCodigoPostal.value = municipio;
                }
            }
        }

        // ============ INICIALIZACI√ìN ============
        // ============ CERRAR MODAL AL HACER CLICK FUERA ============
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal-confirmacion');
            if (modal && event.target === modal) {
                cerrarModal();
            }
        });

        // ============ CERRAR MODAL CON TECLA ESC ============
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                cerrarModal();
            }
        });

        // ============ INICIALIZACI√ìN ============
        document.addEventListener('DOMContentLoaded', function() {
            cargarDirecciones();
            cargarDireccionPrincipal();
        });
    </script>

</body>
</html>
