<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - FullGaming</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo_solo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        /* Bot√≥n para mostrar/ocultar contrase√±a */
        .btn-toggle-pass {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            color: #888;
            transition: color 0.2s;
        }
        .btn-toggle-pass:hover {
            color: #6A44F2;
        }
    </style>
</head>
<body class="perfil-page">
    <!-- MODAL DE CONFIRMACI√ìN -->
    <div id="modal-confirmacion" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <h2 class="modal-title">Eliminar Direcci√≥n</h2>
            <p class="modal-description">¬øEst√°s seguro de que deseas eliminar esta direcci√≥n? Esta acci√≥n no se puede deshacer.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmarEliminacion()">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- MODAL CAMBIAR CONTRASE√ëA CON VERIFICACI√ìN EMAIL -->
    <div id="modal-cambiar-contrase√±a" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 420px;">
            <!-- Paso 1: Solicitar c√≥digo -->
            <div id="paso-solicitar" class="paso-modal">
                <div class="modal-icon">üîê</div>
                <h2 class="modal-title">Cambiar Contrase√±a</h2>
                <p class="modal-description">
                    Por seguridad, enviaremos un c√≥digo de verificaci√≥n a:<br>
                    <strong style="color: #6A44F2;">{{ usuario_email }}</strong>
                </p>
                <div id="error-solicitar" class="alert alert-danger" style="display: none; margin: 10px 0;"></div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="cerrarModalContrase√±a()">Cancelar</button>
                    <button class="modal-btn modal-btn-confirm" id="btn-enviar-codigo" onclick="enviarCodigoContrase√±a()">
                        üìß Enviar C√≥digo
                    </button>
                </div>
            </div>
            
            <!-- Paso 2: Ingresar c√≥digo -->
            <div id="paso-codigo" class="paso-modal" style="display: none;">
                <div class="modal-icon">üì¨</div>
                <h2 class="modal-title">Ingres√° el C√≥digo</h2>
                <p class="modal-description">Enviamos un c√≥digo de 6 d√≠gitos a tu email</p>
                <div style="margin: 20px 0;">
                    <input type="text" id="input-codigo-pass" class="form-control" 
                           placeholder="000000" maxlength="6"
                           style="text-align: center; font-size: 24px; letter-spacing: 8px; font-weight: bold;">
                </div>
                <div id="error-codigo" class="alert alert-danger" style="display: none; margin: 10px 0;"></div>
                <p style="color: #888; font-size: 12px;">El c√≥digo expira en 10 minutos</p>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="volverPasoSolicitar()">‚Üê Volver</button>
                    <button class="modal-btn modal-btn-confirm" id="btn-validar-codigo" onclick="validarCodigoContrase√±a()">
                        Validar
                    </button>
                </div>
            </div>
            
            <!-- Paso 3: Nueva contrase√±a -->
            <div id="paso-nueva-pass" class="paso-modal" style="display: none;">
                <div class="modal-icon">‚ú®</div>
                <h2 class="modal-title">Nueva Contrase√±a</h2>
                <p class="modal-description">C√≥digo verificado. Ingres√° tu nueva contrase√±a.</p>
                <div style="margin: 20px 0;">
                    <div class="mb-3">
                        <label style="color: #bbb; font-size: 12px; display: block; margin-bottom: 5px;">Nueva contrase√±a</label>
                        <div style="position: relative;">
                            <input type="password" id="input-nueva-pass" class="form-control" placeholder="M√≠nimo 6 caracteres" style="padding-right: 45px;">
                            <button type="button" class="btn-toggle-pass" onclick="togglePassword('input-nueva-pass', this)" title="Mostrar contrase√±a">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label style="color: #bbb; font-size: 12px; display: block; margin-bottom: 5px;">Confirmar contrase√±a</label>
                        <div style="position: relative;">
                            <input type="password" id="input-confirmar-pass" class="form-control" placeholder="Repet√≠ la contrase√±a" style="padding-right: 45px;">
                            <button type="button" class="btn-toggle-pass" onclick="togglePassword('input-confirmar-pass', this)" title="Mostrar contrase√±a">üëÅÔ∏è</button>
                        </div>
                    </div>
                </div>
                <div id="error-nueva-pass" class="alert alert-danger" style="display: none; margin: 10px 0;"></div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="cerrarModalContrase√±a()">Cancelar</button>
                    <button class="modal-btn modal-btn-confirm" id="btn-cambiar-pass" onclick="confirmarCambioContrase√±a()">
                        ‚úì Cambiar Contrase√±a
                    </button>
                </div>
            </div>
            
            <!-- Paso 4: √âxito -->
            <div id="paso-exito" class="paso-modal" style="display: none;">
                <div class="modal-icon">‚úÖ</div>
                <h2 class="modal-title">¬°Contrase√±a Actualizada!</h2>
                <p class="modal-description">Tu contrase√±a fue cambiada exitosamente.</p>
                <div class="modal-buttons" style="justify-content: center;">
                    <button class="modal-btn modal-btn-confirm" onclick="cerrarModalContrase√±a()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid perfil-container">
        <!-- BOT√ìN VOLVER ATR√ÅS -->
        <div class="perfil-volver">
            <a href="/" onclick="history.back()" class="volver-btn">
                <span class="icon">‚Üê</span>
                <span>Volver</span>
            </a>
        </div>

        <div class="perfil-header">
            <h1 class="perfil-logo">FULLGAMING</h1>
            <p class="perfil-subtitle">Centro de Comandos</p>
        </div>

        <div class="perfil-content-wrapper">
            <div class="perfil-content">
                <!-- SIDEBAR -->
                <div class="perfil-sidebar">
                    <div class="perfil-card perfil-usuario">
                        <div class="avatar-perfil">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </div>
                        <h3 class="perfil-nombre">{{ usuario_nombre }}</h3>
                        <p class="perfil-email">{{ usuario_email }}</p>
                    </div>

                    <nav class="perfil-nav">
                        <a href="javascript:void(0)" class="perfil-nav-item active" onclick="cambiarSeccion('resumen'); return false;">
                            <span class="icon">üìä</span>
                            <span>Resumen</span>
                        </a>
                        <a href="javascript:void(0)" class="perfil-nav-item" onclick="cambiarSeccion('direcciones'); return false;">
                            <span class="icon">üìç</span>
                            <span>Direcciones</span>
                        </a>
                        <a href="javascript:void(0)" class="perfil-nav-item" onclick="cambiarSeccion('cuenta'); return false;">
                            <span class="icon">‚öôÔ∏è</span>
                            <span>Mi Cuenta</span>
                        </a>
                        <a href="/logout" class="perfil-nav-item logout">
                            <span class="icon">üö™</span>
                            <span>Cerrar sesi√≥n</span>
                        </a>
                    </nav>

                    <!-- Direcci√≥n Principal -->
                    <div class="perfil-card">
                        <h4 style="margin-bottom: 15px;">Direcci√≥n Principal</h4>
                        <div id="direccion-info" class="sin-direccion-sidebar">
                            <p>üìç No tienes una direcci√≥n registrada</p>
                            <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')">
                                Agregar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CONTENIDO PRINCIPAL -->
                <div class="perfil-main">
                    <!-- CARDS SUPERIORES: Pedidos e Informaci√≥n -->
                    <div class="perfil-top-cards">
                        <!-- Pedidos Recientes -->
                        <div>
                            <div class="perfil-card">
                                <h4>Pedidos Recientes</h4>
                                <div class="pedidos-container">
                                    {% if pedidos_recientes|length > 0 %}
                                        <table class="table table-dark table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Pedido</th>
                                                    <th>Fecha</th>
                                                    <th>Total</th>
                                                    <th>Estado</th>
                                                    <th>Acci√≥n</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for pedido in pedidos_recientes %}
                                                <tr>
                                                    <td>#{{ pedido.id }}</td>
                                                    <td>{{ pedido.fecha }}</td>
                                                    <td>${{ "%d" | format(pedido.total) }}</td>
                                                    <td>
                                                        {% if pedido.estado == 'completado' %}
                                                            <span class="badge bg-info">Completado</span>
                                                        {% elif pedido.estado == 'devolucion_pendiente' %}
                                                            <span class="badge bg-warning text-dark">Devoluci√≥n Pendiente</span>
                                                        {% elif pedido.estado == 'devuelto' %}
                                                            <span class="badge bg-success">Devuelto</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">{{ pedido.estado }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if pedido.estado == 'completado' %}
                                                            <button class="btn-devolucion-mini" onclick="abrirFormDevolucion({{ pedido.id }}, {{ pedido.total }})" title="Solicitar devoluci√≥n">
                                                                üîÑ Devolver
                                                            </button>
                                                        {% elif pedido.estado == 'devolucion_pendiente' %}
                                                            <span class="text-warning" style="font-size: 12px;">‚è≥ En revisi√≥n</span>
                                                        {% elif pedido.estado == 'devuelto' %}
                                                            <span class="text-success" style="font-size: 12px;">‚úÖ Devuelto</span>
                                                        {% else %}
                                                            <span style="color: #666; font-size: 12px;">‚Äî</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    {% else %}
                                        <div class="sin-pedidos">
                                            <p>üõçÔ∏è No tienes pedidos a√∫n</p>
                                            <a href="/" class="btn btn-sm" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none;">
                                                Explorar Productos
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n de Cuenta -->
                        <div>
                            <div class="perfil-card">
                                <div class="card-header-perfil">
                                    <h4>Informaci√≥n de Cuenta</h4>
                                    <a href="javascript:void(0)" class="editar-btn" onclick="cambiarSeccion('cuenta')">Editar</a>
                                </div>
                                <div id="info-cuenta" class="info-cuenta">
                                    <div class="info-item">
                                        <label>Nombre</label>
                                        <p>{{ usuario_nombre }}</p>
                                    </div>
                                    <div class="info-item">
                                        <label>Apellido</label>
                                        <p id="info-apellido">{{ usuario_apellido if usuario_apellido else 'üìù No proporcionado' }}</p>
                                    </div>
                                    <div class="info-item">
                                        <label>Email</label>
                                        <p>{{ usuario_email }}</p>
                                    </div>
                                    <div class="info-item">
                                        <label>Tel√©fono</label>
                                        <p id="info-telefono">{{ usuario_telefono if usuario_telefono else 'üì± No proporcionado' }}</p>
                                    </div>
                                    <div class="info-item">
                                        <label>DNI</label>
                                        <p id="info-dni">{{ usuario_dni if usuario_dni else 'üÜî No proporcionado' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN RESUMEN -->
                    <div id="seccion-resumen" class="perfil-section active">
                    </div>

                    <!-- SECCI√ìN DIRECCIONES -->
                    <div id="seccion-direcciones" class="perfil-section">
                        <div class="perfil-card">
                            <div class="card-header-perfil">
                                <h4>Mis Direcciones</h4>
                                <button type="button" class="btn btn-sm" onclick="toggleFormularioDireccion()" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none;">
                                    + Agregar Direcci√≥n
                                </button>
                            </div>

                            <!-- Formulario para agregar direcci√≥n -->
                            <div id="formulario-direccion" style="display: none; margin-bottom: 30px;">
                                <form onsubmit="guardarDireccion(event)">
                                    <div class="mb-3">
                                        <label>Provincia</label>
                                        <select name="provincia" class="form-control" required>
                                            <option value="">Selecciona provincia</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label>Municipio</label>
                                        <select name="municipio" class="form-control" required>
                                            <option value="">Selecciona municipio</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label>Calle</label>
                                        <input type="text" name="calle" class="form-control" placeholder="Ej: Avenida 9 de Julio" required>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>N√∫mero</label>
                                            <input type="text" name="numero" class="form-control" placeholder="Ej: 1234" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Piso/Departamento (opcional)</label>
                                            <input type="text" name="piso_departamento" class="form-control" placeholder="Ej: 5to piso, Depto A">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>C√≥digo Postal</label>
                                        <input type="text" name="codigo_postal" class="form-control" placeholder="Ej: 1425" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label style="display: flex; align-items: center; gap: 10px;">
                                            <input type="checkbox" name="es_principal">
                                            Marcar como direcci√≥n principal
                                        </label>
                                    </div>
                                    <div class="button-group">
                                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none;">
                                            Guardar Direcci√≥n
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="toggleFormularioDireccion()">
                                            Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Lista de direcciones -->
                            <div class="direcciones-list" id="lista-direcciones">
                                <div class="sin-direccion">
                                    <p>üìç No tienes direcciones guardadas</p>
                                    <p class="texto-gris">Las direcciones te ayudar√°n a completar compras m√°s r√°pido</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN CUENTA -->
                    <div id="seccion-cuenta" class="perfil-section">
                        <div class="perfil-card">
                            <h4 style="margin-bottom: 30px;">Editar Informaci√≥n de Cuenta</h4>
                            <form id="form-cuenta" onsubmit="guardarCuenta(event)">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label>Nombre</label>
                                        <input type="text" name="nombre" class="form-control" value="{{ usuario_nombre }}" placeholder="Tu nombre" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>Apellido</label>
                                        <input type="text" name="apellido" class="form-control" value="{{ usuario_apellido if usuario_apellido else '' }}" placeholder="Tu apellido" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label>Email</label>
                                        <input type="email" name="email" class="form-control" value="{{ usuario_email }}" placeholder="Tu email" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label>Tel√©fono</label>
                                        <input type="tel" name="telefono" class="form-control" placeholder="+54 9 11 2345-6789" value="{{ usuario_telefono if usuario_telefono else '' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>DNI</label>
                                        <input type="text" name="dni" class="form-control" placeholder="XX.XXX.XXX" value="{{ usuario_dni if usuario_dni else '' }}">
                                    </div>
                                </div>
                                <!-- Secci√≥n Cambiar Contrase√±a - con verificaci√≥n por email -->
                                <div class="mb-3">
                                    <label>Contrase√±a</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="password" class="form-control" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" disabled style="max-width: 200px;">
                                        <button type="button" class="btn btn-outline-light btn-sm" onclick="abrirModalCambiarContrase√±a()" style="white-space: nowrap;">
                                            üîê Cambiar contrase√±a
                                        </button>
                                    </div>
                                    <small style="color: #8b82d4; font-size: 12px;">üìß Se enviar√° un c√≥digo de verificaci√≥n a tu email</small>
                                </div>
                                <div class="button-group">
                                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none;">
                                        Guardar Cambios
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="cambiarSeccion('resumen')">
                                        Cancelar
                                    </button>
                                </div>
                            </form>

                            <!-- ========== ZONA PELIGROSA ========== -->
                            {% if session.get('es_admin') != 1 %}
                            <div class="zona-peligrosa">
                                <div class="zona-peligrosa-header">
                                    <h5>‚ö†Ô∏è Zona Peligrosa</h5>
                                    <p>Acciones irreversibles sobre tu cuenta</p>
                                </div>
                                <div class="zona-peligrosa-content">
                                    <div class="zona-peligrosa-info">
                                        <strong>üóëÔ∏è Eliminar cuenta</strong>
                                        <p>Esta acci√≥n es permanente y eliminar√° todos tus datos, pedidos y direcciones.</p>
                                    </div>
                                    <button type="button" class="btn-eliminar-cuenta" onclick="abrirModalEliminarCuenta()">
                                        üóëÔ∏è Eliminar mi cuenta
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SOLICITAR DEVOLUCI√ìN -->
    <div id="modal-devolucion" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <!-- Paso 1: Formulario -->
            <div id="devolucion-paso-form" class="paso-modal">
                <div class="modal-icon" style="font-size: 48px;">üîÑ</div>
                <h2 class="modal-title" style="color: #6A44F2;">Solicitar Devoluci√≥n</h2>
                <p class="modal-description">Pedido <strong id="devolucion-pedido-num"></strong> ‚Äî Total: <strong id="devolucion-pedido-monto"></strong></p>
                
                <div style="margin: 20px 0;">
                    <label style="color: #bbb; font-size: 12px; display: block; margin-bottom: 5px;">Motivo de devoluci√≥n *</label>
                    <select id="devolucion-motivo" class="form-control" style="background: #1a1f2e; color: white; border: 1px solid #3C308C; border-radius: 8px; padding: 10px;">
                        <option value="">Seleccion√° un motivo</option>
                        <option value="producto_defectuoso">üîß Producto defectuoso</option>
                        <option value="no_coincide">üì¶ No coincide con la descripci√≥n</option>
                        <option value="arrepentimiento">üí≠ Arrepentimiento de compra</option>
                        <option value="otro">üìù Otro motivo</option>
                    </select>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="color: #bbb; font-size: 12px; display: block; margin-bottom: 5px;">Comentarios adicionales (opcional)</label>
                    <textarea id="devolucion-comentarios" class="form-control" rows="3" placeholder="Describ√≠ el problema o raz√≥n..." 
                        style="background: #1a1f2e; color: white; border: 1px solid #3C308C; border-radius: 8px; padding: 10px; resize: vertical;"></textarea>
                </div>
                
                <div style="background: rgba(106, 68, 242, 0.1); border: 1px solid rgba(106, 68, 242, 0.3); border-radius: 10px; padding: 12px; margin: 15px 0;">
                    <p style="color: #8b82d4; font-size: 12px; margin: 0;">
                        ‚ÑπÔ∏è Tu solicitud ser√° revisada por nuestro equipo. Te notificaremos por email cuando sea procesada.
                    </p>
                </div>
                
                <div id="error-devolucion" style="display: none; background: rgba(231, 76, 60, 0.15); border: 1px solid rgba(231, 76, 60, 0.4); color: #e74c3c; padding: 10px; border-radius: 8px; font-size: 13px; margin: 10px 0;"></div>
                
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="cerrarModalDevolucion()">Cancelar</button>
                    <button class="modal-btn modal-btn-confirm" id="btn-enviar-devolucion" onclick="enviarSolicitudDevolucion()">
                        üì§ Enviar Solicitud
                    </button>
                </div>
            </div>
            
            <!-- Paso 2: √âxito -->
            <div id="devolucion-paso-exito" class="paso-modal" style="display: none;">
                <div class="modal-icon" style="font-size: 48px;">‚úÖ</div>
                <h2 class="modal-title" style="color: #2ecc71;">Solicitud Enviada</h2>
                <p class="modal-description">Tu solicitud de devoluci√≥n fue registrada correctamente. Te notificaremos por email cuando sea procesada.</p>
                <div class="modal-buttons" style="justify-content: center;">
                    <button class="modal-btn modal-btn-confirm" onclick="cerrarModalDevolucion(); location.reload();">Entendido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ELIMINAR CUENTA -->
    <div id="modal-eliminar-cuenta" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 460px;">
            <!-- Paso 1: Advertencia -->
            <div id="eliminar-paso-1" class="paso-modal">
                <div class="modal-icon" style="font-size: 48px;">üö®</div>
                <h2 class="modal-title" style="color: #e74c3c;">¬øEliminar tu cuenta?</h2>
                <div style="background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 10px; padding: 15px; margin: 15px 0;">
                    <p style="color: #e74c3c; font-weight: 600; margin: 0 0 8px 0; font-size: 14px;">‚ö†Ô∏è Esta acci√≥n es PERMANENTE</p>
                    <ul style="color: #bbb; font-size: 13px; margin: 0; padding-left: 18px; list-style: disc;">
                        <li>Se eliminar√°n todos tus datos personales</li>
                        <li>Se eliminar√°n tus pedidos e historial</li>
                        <li>Se eliminar√°n tus direcciones guardadas</li>
                        <li>No podr√°s recuperar tu cuenta</li>
                    </ul>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="cerrarModalEliminarCuenta()">Cancelar</button>
                    <button class="modal-btn" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;" onclick="mostrarPasoConfirmar()">
                        Continuar
                    </button>
                </div>
            </div>

            <!-- Paso 2: Confirmar con contrase√±a -->
            <div id="eliminar-paso-2" class="paso-modal" style="display: none;">
                <div class="modal-icon" style="font-size: 48px;">üîê</div>
                <h2 class="modal-title" style="color: #e74c3c;">Confirm√° tu identidad</h2>
                <p class="modal-description">Ingres√° tu contrase√±a actual para confirmar la eliminaci√≥n</p>
                <div style="margin: 20px 0;">
                    <div style="position: relative;">
                        <input type="password" id="input-pass-eliminar" class="form-control" 
                               placeholder="Tu contrase√±a actual" 
                               style="padding-right: 45px; font-size: 16px;"
                               onkeydown="if(event.key==='Enter') ejecutarEliminacion()">
                        <button type="button" class="btn-toggle-pass" onclick="togglePassword('input-pass-eliminar', this)" title="Mostrar contrase√±a">üëÅÔ∏è</button>
                    </div>
                </div>
                <div id="error-eliminar" style="display: none; background: rgba(231, 76, 60, 0.15); border: 1px solid rgba(231, 76, 60, 0.4); color: #e74c3c; padding: 10px; border-radius: 8px; font-size: 13px; margin: 10px 0;"></div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="volverPasoAdvertencia()">‚Üê Volver</button>
                    <button class="modal-btn" id="btn-confirmar-eliminar" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;" onclick="ejecutarEliminacion()">
                        üóëÔ∏è Eliminar definitivamente
                    </button>
                </div>
            </div>

            <!-- Paso 3: Procesando / √âxito -->
            <div id="eliminar-paso-3" class="paso-modal" style="display: none;">
                <div class="modal-icon" style="font-size: 48px;">‚úÖ</div>
                <h2 class="modal-title" style="color: #2ecc71;">Cuenta eliminada</h2>
                <p class="modal-description">Tu cuenta fue eliminada correctamente. Ser√°s redirigido al inicio...</p>
            </div>
        </div>
    </div>

    <script>
        // ============ ESTADO GLOBAL ============
        let direccionEnEdicion = null;  // ID de la direcci√≥n que se est√° editando
        
        // ============ TOGGLE PASSWORD ============
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
                btn.title = 'Ocultar contrase√±a';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
                btn.title = 'Mostrar contrase√±a';
            }
        }
        
        // ============ UTILIDADES ============
        function mostrarNotificacion(mensaje, esError = false) {
            const notif = document.createElement('div');
            notif.className = 'notificacion' + (esError ? ' error' : '');
            notif.textContent = mensaje;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function cambiarSeccion(seccion) {
            console.log('Cambiando a secci√≥n:', seccion);
            
            document.querySelectorAll('.perfil-section').forEach(s => {
                s.classList.remove('active');
            });
            document.querySelectorAll('.perfil-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const sectionEl = document.getElementById(`seccion-${seccion}`);
            if (sectionEl) {
                sectionEl.classList.add('active');
            }

            // Marcar nav como activo
            const navItems = document.querySelectorAll('.perfil-nav-item');
            if (seccion === 'resumen') {
                navItems[0]?.classList.add('active');
            } else if (seccion === 'direcciones') {
                navItems[1]?.classList.add('active');
                cargarDirecciones();
                cargarDireccionPrincipal();
                cargarProvincias();
            } else if (seccion === 'cuenta') {
                navItems[2]?.classList.add('active');
            }
        }

        // ============ PERFIL - ACTUALIZAR DATOS ============
        function guardarCuenta(event) {
            event.preventDefault();

            const form = document.getElementById('form-cuenta');
            const nombre = form.querySelector('input[name="nombre"]').value.trim();
            const apellido = form.querySelector('input[name="apellido"]').value.trim();
            const email = form.querySelector('input[name="email"]').value.trim();
            const telefono = form.querySelector('input[name="telefono"]').value.trim();
            const dni = form.querySelector('input[name="dni"]').value.trim();

            if (!nombre || !apellido || !email) {
                mostrarNotificacion('‚ùå Nombre, apellido y email son obligatorios', true);
                return;
            }

            const datos = {
                nombre: nombre,
                apellido: apellido,
                email: email,
                telefono: telefono,
                dni: dni
            };

            fetch('/api/perfil/actualizar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    mostrarNotificacion('‚úì Perfil actualizado correctamente');
                    // Actualizar el apellido en la informaci√≥n de cuenta
                    const infoApellido = document.getElementById('info-apellido');
                    if (infoApellido) {
                        infoApellido.textContent = apellido || 'üìù No proporcionado';
                    }
                    // Actualizar el tel√©fono en la informaci√≥n de cuenta
                    const infoBailoTelefono = document.getElementById('info-telefono');
                    if (infoBailoTelefono) {
                        infoBailoTelefono.textContent = telefono || 'üì± No proporcionado';
                    }
                    // Actualizar el DNI en la informaci√≥n de cuenta
                    const infoDni = document.getElementById('info-dni');
                    if (infoDni) {
                        infoDni.textContent = dni || 'üÜî No proporcionado';
                    }
                    setTimeout(() => location.reload(), 1500);
                } else {
                    mostrarNotificacion('‚ùå ' + (data.error || 'Error al actualizar'), true);
                }
            })
            .catch(err => {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            });
        }

        // ============ DIRECCIONES - TOGGLE FORMULARIO ============
        function toggleFormularioDireccion() {
            const formulario = document.getElementById('formulario-direccion');
            if (formulario) {
                const estaOculto = formulario.style.display === 'none';
                formulario.style.display = estaOculto ? 'block' : 'none';
                
                // Si se est√° cerrando, limpiar el estado de edici√≥n
                if (!estaOculto) {
                    direccionEnEdicion = null;
                    const formInterno = formulario.querySelector('form');
                    if (formInterno) {
                        formInterno.reset();
                    }
                    // Restaurar bot√≥n
                    const btnSubmit = formulario.querySelector('button[type="submit"]');
                    if (btnSubmit) {
                        btnSubmit.textContent = 'Guardar Direcci√≥n';
                    }
                }
            }
        }

        // ============ DIRECCIONES - GUARDAR ============
        async function guardarDireccion(event) {
            event.preventDefault();

            const form = event.target;
            const datos = {
                provincia: form.querySelector('select[name="provincia"]').value,
                municipio: form.querySelector('select[name="municipio"]').value,
                calle: form.querySelector('input[name="calle"]').value,
                numero: form.querySelector('input[name="numero"]').value,
                piso_departamento: form.querySelector('input[name="piso_departamento"]').value,
                codigo_postal: form.querySelector('input[name="codigo_postal"]').value,
                es_principal: form.querySelector('input[name="es_principal"]').checked
            };

            if (!datos.provincia || !datos.municipio || !datos.calle || !datos.numero) {
                mostrarNotificacion('‚ùå Completa todos los campos obligatorios', true);
                return;
            }

            // Si hay una direcci√≥n en edici√≥n, llamar a actualizar en lugar de crear
            if (direccionEnEdicion) {
                guardarEdicionDireccion(event, direccionEnEdicion);
                return;
            }

            try {
                const res = await fetch('/api/direcciones/crear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });

                const data = await res.json();

                if (data.ok) {
                    mostrarNotificacion('‚úì Direcci√≥n guardada correctamente');
                    form.reset();
                    toggleFormularioDireccion();
                    await cargarDirecciones();
                    await cargarDireccionPrincipal();
                } else {
                    mostrarNotificacion('‚ùå ' + (data.error || 'Error al guardar'), true);
                }
            } catch (err) {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            }
        }

        // ============ DIRECCIONES - CARGAR LISTA ============
        async function cargarDirecciones() {
            try {
                const res = await fetch('/api/direcciones');
                const data = await res.json();
                
                const listaDirecciones = document.getElementById('lista-direcciones');
                if (!listaDirecciones) return;

                if (data.ok && data.direcciones && data.direcciones.length > 0) {
                    listaDirecciones.innerHTML = data.direcciones.map(dir => `
                        <div class="perfil-card" style="margin-bottom: 15px; position: relative;">
                            ${dir.es_principal ? '<div style="position: absolute; top: 10px; right: 10px; background: #FFD700; color: #333; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold;">‚≠ê Principal</div>' : ''}
                            <div class="card-header-perfil" style="align-items: flex-start; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 8px 0;">${dir.calle} ${dir.numero}</h5>
                                    ${dir.piso_departamento ? `<p style="margin: 0 0 8px 0; color: #999; font-size: 14px;">${dir.piso_departamento}</p>` : ''}
                                    <p style="margin: 0;">üìç ${dir.municipio}, ${dir.provincia}</p>
                                    <p style="margin: 5px 0; color: #999; font-size: 13px;">CP: ${dir.codigo_postal}</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${!dir.es_principal ? `<button type="button" onclick="establecerPrincipal(${dir.id})" class="btn btn-sm" style="background: linear-gradient(135deg, #6A44F2, #3C308C); color: white; border: none; flex: 1;">‚≠ê Hacer Principal</button>` : ''}
                                <button type="button" onclick="editarDireccion(${dir.id})" class="btn btn-sm" style="background: #3498db; color: white; border: none; flex: 1;">‚úèÔ∏è Editar</button>
                                <button type="button" onclick="eliminarDireccion(${dir.id})" class="btn btn-sm" style="background: #e74c3c; color: white; border: none; flex: 1;">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listaDirecciones.innerHTML = `
                        <div class="sin-direccion">
                            <p>üìç No tienes direcciones guardadas</p>
                            <p class="texto-gris">Las direcciones te ayudar√°n a completar compras m√°s r√°pido</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error cargando direcciones:', err);
            }
        }

        // ============ CARGAR DIRECCI√ìN PRINCIPAL EN SIDEBAR ============
        async function cargarDireccionPrincipal() {
            try {
                const res = await fetch('/api/direcciones');
                const data = await res.json();
                
                const direccionInfo = document.getElementById('direccion-info');
                if (!direccionInfo) return;

                if (data.ok && data.direcciones && data.direcciones.length > 0) {
                    // Buscar la direcci√≥n principal
                    const direccionPrincipal = data.direcciones.find(dir => dir.es_principal);
                    
                    if (direccionPrincipal) {
                        // Mostrar direcci√≥n principal
                        direccionInfo.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <p style="font-weight: bold; margin-bottom: 5px;">‚≠ê ${direccionPrincipal.calle} ${direccionPrincipal.numero}</p>
                                ${direccionPrincipal.piso_departamento ? `<p style="margin: 3px 0; font-size: 0.9em;">${direccionPrincipal.piso_departamento}</p>` : ''}
                                <p style="margin: 3px 0; color: #999;">${direccionPrincipal.municipio}, ${direccionPrincipal.provincia}</p>
                                <p style="margin: 3px 0; color: #999; font-size: 0.85em;">CP: ${direccionPrincipal.codigo_postal}</p>
                            </div>
                            <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')" style="width: 100%; margin-top: 10px;">
                                Editar
                            </button>
                        `;
                    } else if (data.direcciones.length > 0) {
                        // Hay direcciones pero ninguna es principal, mostrar la primera
                        const dir = data.direcciones[0];
                        direccionInfo.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <p style="font-weight: bold; margin-bottom: 5px;">${dir.calle} ${dir.numero}</p>
                                ${dir.piso_departamento ? `<p style="margin: 3px 0; font-size: 0.9em;">${dir.piso_departamento}</p>` : ''}
                                <p style="margin: 3px 0; color: #999;">${dir.municipio}, ${dir.provincia}</p>
                                <p style="margin: 3px 0; color: #999; font-size: 0.85em;">CP: ${dir.codigo_postal}</p>
                            </div>
                            <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')" style="width: 100%; margin-top: 10px;">
                                Editar
                            </button>
                        `;
                    } else {
                        // No hay direcciones
                        direccionInfo.innerHTML = `
                            <p>üìç No tienes una direcci√≥n registrada</p>
                            <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')">
                                Agregar
                            </button>
                        `;
                    }
                } else {
                    // Error o sin direcciones
                    direccionInfo.innerHTML = `
                        <p>üìç No tienes una direcci√≥n registrada</p>
                        <button type="button" class="btn btn-sm btn-direccion" onclick="cambiarSeccion('direcciones')">
                            Agregar
                        </button>
                    `;
                }
            } catch (err) {
                console.error('Error cargando direcci√≥n principal:', err);
            }
        }

        // ============ MODAL DE CONFIRMACI√ìN ============
        let direccionAEliminar = null;

        function abrirModalEliminar(id) {
            direccionAEliminar = id;
            const modal = document.getElementById('modal-confirmacion');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function cerrarModal() {
            const modal = document.getElementById('modal-confirmacion');
            if (modal) {
                modal.classList.remove('active');
            }
            direccionAEliminar = null;
        }

        function confirmarEliminacion() {
            if (direccionAEliminar === null) return;

            const id = direccionAEliminar;
            cerrarModal();

            fetch(`/api/direcciones/${id}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    mostrarNotificacion('‚úì Direcci√≥n eliminada');
                    cargarDirecciones();
                    cargarDireccionPrincipal();
                } else {
                    mostrarNotificacion('‚ùå Error al eliminar', true);
                }
            })
            .catch(err => {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            });
        }

        // ============ DIRECCIONES - ELIMINAR ============
        function eliminarDireccion(id) {
            abrirModalEliminar(id);
        }

        // ============ ESTABLECER DIRECCI√ìN COMO PRINCIPAL ============
        function establecerPrincipal(id) {
            fetch(`/api/direcciones/${id}/principal`, {
                method: 'PUT'
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    mostrarNotificacion('‚úì Direcci√≥n establecida como principal');
                    cargarDirecciones();
                    cargarDireccionPrincipal();
                } else {
                    mostrarNotificacion('‚ùå Error al cambiar direcci√≥n principal', true);
                }
            })
            .catch(err => {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            });
        }

        // ============ EDITAR DIRECCI√ìN ============
        async function editarDireccion(id) {
            try {
                // Establecer que estamos en modo edici√≥n
                direccionEnEdicion = id;
                
                // Cargar datos de la direcci√≥n
                const res = await fetch(`/api/direcciones/${id}`);
                const data = await res.json();

                if (data.ok && data.direccion) {
                    const dir = data.direccion;
                    
                    // Llenar el formulario con los datos actuales
                    document.querySelector('select[name="provincia"]').value = dir.provincia;
                    
                    // Cargar municipios
                    await cargarMunicipiosEdicion(dir.provincia);
                    document.querySelector('select[name="municipio"]').value = dir.municipio;
                    
                    // Llenar otros campos
                    document.querySelector('input[name="calle"]').value = dir.calle;
                    document.querySelector('input[name="numero"]').value = dir.numero;
                    document.querySelector('input[name="piso_departamento"]').value = dir.piso_departamento || '';
                    
                    // Cargar c√≥digo postal
                    const inputCP = document.querySelector('input[name="codigo_postal"]');
                    if (inputCP) {
                        inputCP.value = dir.codigo_postal;
                    }
                    
                    document.querySelector('input[name="es_principal"]').checked = dir.es_principal;
                    
                    // Cambiar el formulario para edici√≥n
                    const formulario = document.getElementById('formulario-direccion');
                    if (formulario) {
                        formulario.style.display = 'block';
                        
                        // Cambiar el bot√≥n
                        const btnSubmit = formulario.querySelector('button[type="submit"]');
                        if (btnSubmit) {
                            btnSubmit.textContent = 'Guardar Cambios';
                        }
                    }
                    
                    // Desplazarse al formulario
                    cambiarSeccion('direcciones');
                    setTimeout(() => {
                        formulario.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                } else {
                    mostrarNotificacion('‚ùå Error al cargar direcci√≥n', true);
                    direccionEnEdicion = null;
                }
            } catch (err) {
                mostrarNotificacion('‚ùå Error al cargar direcci√≥n', true);
                console.error(err);
                direccionEnEdicion = null;
            }
        }

        // Cargar municipios para edici√≥n
        async function cargarMunicipiosEdicion(provincia) {
            try {
                const res = await fetch(`/api/municipios/${encodeURIComponent(provincia)}`);
                const data = await res.json();
                
                if (data.ok && data.municipios) {
                    const selectMunicipio = document.querySelector('select[name="municipio"]');
                    if (selectMunicipio) {
                        selectMunicipio.innerHTML = '<option value="">Selecciona municipio</option>';
                        data.municipios.forEach(m => {
                            const option = document.createElement('option');
                            option.value = m;
                            option.textContent = m;
                            selectMunicipio.appendChild(option);
                        });
                    }
                }
            } catch (err) {
                console.error('Error cargando municipios:', err);
            }
        }

        // ============ GUARDAR EDICI√ìN DE DIRECCI√ìN ============
        function guardarEdicionDireccion(event, id) {
            event.preventDefault();

            const form = event.target;
            const datos = {
                provincia: form.querySelector('select[name="provincia"]').value,
                municipio: form.querySelector('select[name="municipio"]').value,
                calle: form.querySelector('input[name="calle"]').value,
                numero: form.querySelector('input[name="numero"]').value,
                piso_departamento: form.querySelector('input[name="piso_departamento"]').value,
                codigo_postal: form.querySelector('input[name="codigo_postal"]').value,
                es_principal: form.querySelector('input[name="es_principal"]').checked
            };

            if (!datos.provincia || !datos.municipio || !datos.calle || !datos.numero) {
                mostrarNotificacion('‚ùå Completa todos los campos obligatorios', true);
                return;
            }

            fetch(`/api/direcciones/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    mostrarNotificacion('‚úì Direcci√≥n actualizada correctamente');
                    form.reset();
                    toggleFormularioDireccion();
                    
                    // Limpiar el estado de edici√≥n
                    direccionEnEdicion = null;
                    
                    // Restaurar bot√≥n
                    const btnSubmit = form.querySelector('button[type="submit"]');
                    if (btnSubmit) {
                        btnSubmit.textContent = 'Guardar Direcci√≥n';
                    }
                    
                    cargarDirecciones();
                    cargarDireccionPrincipal();
                } else {
                    mostrarNotificacion('‚ùå ' + (data.error || 'Error al guardar'), true);
                }
            })
            .catch(err => {
                mostrarNotificacion('‚ùå Error de conexi√≥n', true);
                console.error(err);
            });
        }

        // ============ DIRECCIONES - CARGAR PROVINCIAS ============
        async function cargarProvincias() {
            try {
                const res = await fetch('/api/provincias');
                const data = await res.json();
                
                if (data.ok && data.provincias) {
                    const selectProvincia = document.querySelector('select[name="provincia"]');
                    if (selectProvincia && selectProvincia.options.length === 1) {
                        data.provincias.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p;
                            option.textContent = p;
                            selectProvincia.appendChild(option);
                        });
                        selectProvincia.addEventListener('change', cargarMunicipios);
                    }
                }
            } catch (err) {
                console.error('Error cargando provincias:', err);
            }
        }

        // ============ DIRECCIONES - CARGAR MUNICIPIOS ============
        async function cargarMunicipios(event) {
            const provincia = event.target.value;
            if (!provincia) return;

            try {
                const res = await fetch(`/api/municipios/${encodeURIComponent(provincia)}`);
                const data = await res.json();
                
                if (data.ok && data.municipios) {
                    const selectMunicipio = document.querySelector('select[name="municipio"]');
                    if (selectMunicipio) {
                        selectMunicipio.innerHTML = '<option value="">Selecciona municipio</option>';
                        data.municipios.forEach(m => {
                            const option = document.createElement('option');
                            option.value = m;
                            option.textContent = m;
                            selectMunicipio.appendChild(option);
                        });
                        selectMunicipio.addEventListener('change', cargarCodigoPostal);
                    }
                }
            } catch (err) {
                console.error('Error cargando municipios:', err);
            }
        }

        // ============ DIRECCIONES - CARGAR C√ìDIGO POSTAL ============
        async function cargarCodigoPostal(event) {
            const provincia = document.querySelector('select[name="provincia"]').value;
            const municipio = event.target.value;

            if (!provincia || !municipio) return;

            try {
                const res = await fetch(`/api/codigo-postal/${encodeURIComponent(provincia)}/${encodeURIComponent(municipio)}`);
                const data = await res.json();
                
                const inputCodigoPostal = document.querySelector('input[name="codigo_postal"]');
                if (inputCodigoPostal && data.ok) {
                    inputCodigoPostal.value = data.codigo_postal;
                } else if (inputCodigoPostal) {
                    inputCodigoPostal.value = municipio;
                }
            } catch (err) {
                console.error('Error cargando c√≥digo postal:', err);
                const inputCodigoPostal = document.querySelector('input[name="codigo_postal"]');
                if (inputCodigoPostal) {
                    inputCodigoPostal.value = municipio;
                }
            }
        }

        // ============ INICIALIZACI√ìN ============
        // ============ CERRAR MODAL AL HACER CLICK FUERA ============
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal-confirmacion');
            if (modal && event.target === modal) {
                cerrarModal();
            }
        });

        // ============ CERRAR MODAL CON TECLA ESC ============
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                cerrarModal();
                cerrarModalContrase√±a();
            }
        });

        // ============ CAMBIO DE CONTRASE√ëA CON VERIFICACI√ìN EMAIL ============
        let codigoValidado = '';  // Guarda el c√≥digo validado para paso 3
        
        function abrirModalCambiarContrase√±a() {
            const modal = document.getElementById('modal-cambiar-contrase√±a');
            modal.style.display = 'flex';
            // Resetear a paso 1
            mostrarPasoModal('paso-solicitar');
            // Limpiar campos
            document.getElementById('input-codigo-pass').value = '';
            document.getElementById('input-nueva-pass').value = '';
            document.getElementById('input-confirmar-pass').value = '';
            codigoValidado = '';
            // Ocultar errores
            ocultarErroresModal();
        }
        
        function cerrarModalContrase√±a() {
            const modal = document.getElementById('modal-cambiar-contrase√±a');
            modal.style.display = 'none';
        }
        
        function mostrarPasoModal(pasoId) {
            document.querySelectorAll('.paso-modal').forEach(p => p.style.display = 'none');
            document.getElementById(pasoId).style.display = 'block';
        }
        
        function ocultarErroresModal() {
            ['error-solicitar', 'error-codigo', 'error-nueva-pass'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }
        
        function mostrarErrorModal(elementId, mensaje) {
            const el = document.getElementById(elementId);
            el.textContent = mensaje;
            el.style.display = 'block';
        }
        
        function volverPasoSolicitar() {
            mostrarPasoModal('paso-solicitar');
            ocultarErroresModal();
        }
        
        async function enviarCodigoContrase√±a() {
            const btn = document.getElementById('btn-enviar-codigo');
            btn.disabled = true;
            btn.textContent = 'Enviando...';
            ocultarErroresModal();
            
            try {
                const resp = await fetch('/api/perfil/solicitar-cambio-contrase√±a', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await resp.json();
                
                if (data.ok) {
                    mostrarPasoModal('paso-codigo');
                    // En modo desarrollo, mostrar el c√≥digo
                    if (data.dev_mode && data.codigo_dev) {
                        alert(`üîë MODO DESARROLLO\n\nTu c√≥digo es: ${data.codigo_dev}`);
                    }
                } else {
                    mostrarErrorModal('error-solicitar', data.error || 'Error al enviar c√≥digo');
                }
            } catch (err) {
                mostrarErrorModal('error-solicitar', 'Error de conexi√≥n');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìß Enviar C√≥digo';
            }
        }
        
        async function validarCodigoContrase√±a() {
            const codigo = document.getElementById('input-codigo-pass').value.trim();
            const btn = document.getElementById('btn-validar-codigo');
            
            if (!codigo || codigo.length !== 6) {
                mostrarErrorModal('error-codigo', 'Ingres√° el c√≥digo de 6 d√≠gitos');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Validando...';
            ocultarErroresModal();
            
            try {
                const resp = await fetch('/api/perfil/validar-codigo-contrase√±a', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codigo })
                });
                
                const data = await resp.json();
                
                if (data.ok) {
                    codigoValidado = codigo;
                    mostrarPasoModal('paso-nueva-pass');
                } else {
                    mostrarErrorModal('error-codigo', data.error || 'C√≥digo inv√°lido');
                }
            } catch (err) {
                mostrarErrorModal('error-codigo', 'Error de conexi√≥n');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Validar';
            }
        }
        
        async function confirmarCambioContrase√±a() {
            const nuevaPass = document.getElementById('input-nueva-pass').value;
            const confirmarPass = document.getElementById('input-confirmar-pass').value;
            const btn = document.getElementById('btn-cambiar-pass');
            
            // Validaciones
            if (!nuevaPass || nuevaPass.length < 6) {
                mostrarErrorModal('error-nueva-pass', 'La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            if (nuevaPass !== confirmarPass) {
                mostrarErrorModal('error-nueva-pass', 'Las contrase√±as no coinciden');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            ocultarErroresModal();
            
            try {
                const resp = await fetch('/api/perfil/confirmar-cambio-contrase√±a', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo: codigoValidado,
                        nueva_contrase√±a: nuevaPass,
                        confirmar_contrase√±a: confirmarPass
                    })
                });
                
                const data = await resp.json();
                
                if (data.ok) {
                    mostrarPasoModal('paso-exito');
                    mostrarNotificacion('¬°Contrase√±a actualizada correctamente!');
                } else {
                    mostrarErrorModal('error-nueva-pass', data.error || 'Error al cambiar contrase√±a');
                }
            } catch (err) {
                mostrarErrorModal('error-nueva-pass', 'Error de conexi√≥n');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚úì Cambiar Contrase√±a';
            }
        }
        
        // Cerrar modal al hacer click fuera
        document.getElementById('modal-cambiar-contrase√±a').addEventListener('click', function(event) {
            if (event.target === this) {
                cerrarModalContrase√±a();
            }
        });

        // ============ DEVOLUCIONES ============
        let devolucionPedidoId = null;

        function abrirFormDevolucion(pedidoId, montoTotal) {
            devolucionPedidoId = pedidoId;
            document.getElementById('devolucion-pedido-num').textContent = '#' + pedidoId;
            document.getElementById('devolucion-pedido-monto').textContent = '$' + montoTotal.toLocaleString('es-AR');
            document.getElementById('devolucion-motivo').value = '';
            document.getElementById('devolucion-comentarios').value = '';
            document.getElementById('error-devolucion').style.display = 'none';
            document.getElementById('devolucion-paso-form').style.display = 'block';
            document.getElementById('devolucion-paso-exito').style.display = 'none';
            document.getElementById('modal-devolucion').style.display = 'flex';
        }

        function cerrarModalDevolucion() {
            document.getElementById('modal-devolucion').style.display = 'none';
            devolucionPedidoId = null;
        }

        async function enviarSolicitudDevolucion() {
            const motivo = document.getElementById('devolucion-motivo').value;
            const comentarios = document.getElementById('devolucion-comentarios').value.trim();
            const errorDiv = document.getElementById('error-devolucion');
            const btn = document.getElementById('btn-enviar-devolucion');

            if (!motivo) {
                errorDiv.textContent = '‚ö†Ô∏è Deb√©s seleccionar un motivo';
                errorDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Enviando...';
            errorDiv.style.display = 'none';

            try {
                const resp = await fetch('/api/devoluciones/solicitar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pedido_id: devolucionPedidoId,
                        motivo: motivo,
                        comentarios: comentarios
                    })
                });

                const data = await resp.json();

                if (data.ok) {
                    document.getElementById('devolucion-paso-form').style.display = 'none';
                    document.getElementById('devolucion-paso-exito').style.display = 'block';
                    mostrarNotificacion('‚úì Solicitud de devoluci√≥n enviada');
                } else {
                    errorDiv.textContent = '‚ùå ' + (data.error || 'Error al enviar solicitud');
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                errorDiv.textContent = '‚ùå Error de conexi√≥n. Intent√° de nuevo.';
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì§ Enviar Solicitud';
            }
        }

        // Cerrar modal devoluci√≥n al hacer click fuera
        document.getElementById('modal-devolucion').addEventListener('click', function(event) {
            if (event.target === this) {
                cerrarModalDevolucion();
            }
        });

        // ============ ELIMINAR CUENTA ============
        function abrirModalEliminarCuenta() {
            document.getElementById('modal-eliminar-cuenta').style.display = 'flex';
            document.getElementById('eliminar-paso-1').style.display = 'block';
            document.getElementById('eliminar-paso-2').style.display = 'none';
            document.getElementById('eliminar-paso-3').style.display = 'none';
            document.getElementById('input-pass-eliminar').value = '';
            document.getElementById('error-eliminar').style.display = 'none';
        }

        function cerrarModalEliminarCuenta() {
            document.getElementById('modal-eliminar-cuenta').style.display = 'none';
            document.getElementById('input-pass-eliminar').value = '';
        }

        function mostrarPasoConfirmar() {
            document.getElementById('eliminar-paso-1').style.display = 'none';
            document.getElementById('eliminar-paso-2').style.display = 'block';
            document.getElementById('error-eliminar').style.display = 'none';
            // Focus en el input de contrase√±a
            setTimeout(() => document.getElementById('input-pass-eliminar').focus(), 100);
        }

        function volverPasoAdvertencia() {
            document.getElementById('eliminar-paso-2').style.display = 'none';
            document.getElementById('eliminar-paso-1').style.display = 'block';
        }

        async function ejecutarEliminacion() {
            const contrase√±a = document.getElementById('input-pass-eliminar').value.trim();
            const errorDiv = document.getElementById('error-eliminar');
            const btn = document.getElementById('btn-confirmar-eliminar');

            if (!contrase√±a) {
                errorDiv.textContent = '‚ö†Ô∏è Deb√©s ingresar tu contrase√±a';
                errorDiv.style.display = 'block';
                return;
            }

            // Estado de carga
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Eliminando...';
            errorDiv.style.display = 'none';

            try {
                const resp = await fetch('/api/eliminar-cuenta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contrase√±a: contrase√±a })
                });

                const data = await resp.json();

                if (data.ok) {
                    // √âxito - Mostrar paso 3
                    document.getElementById('eliminar-paso-2').style.display = 'none';
                    document.getElementById('eliminar-paso-3').style.display = 'block';
                    // Redirigir despu√©s de 2.5 segundos
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2500);
                } else {
                    errorDiv.textContent = '‚ùå ' + (data.error || 'Error al eliminar la cuenta');
                    errorDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = 'üóëÔ∏è Eliminar definitivamente';
                }
            } catch (err) {
                errorDiv.textContent = '‚ùå Error de conexi√≥n. Intent√° de nuevo.';
                errorDiv.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = 'üóëÔ∏è Eliminar definitivamente';
            }
        }

        // Cerrar modal eliminar cuenta al hacer click fuera
        document.getElementById('modal-eliminar-cuenta').addEventListener('click', function(event) {
            if (event.target === this) {
                cerrarModalEliminarCuenta();
            }
        });

        // ============ INICIALIZACI√ìN ============
        document.addEventListener('DOMContentLoaded', function() {
            document.documentElement.classList.add('perfil-page-root');
            cargarDirecciones();
            cargarDireccionPrincipal();
        });
    </script>

</body>
</html>
