<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FullGaming</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo_solo.png') }}">
    <link rel="stylesheet"  href="{{ url_for('static', filename='css/index.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* ===== MODAL OSCURO PERSONALIZADO ===== */
        .modal-overlay-custom {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .modal-overlay-custom.active {
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }
        .modal-body-custom {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1f4f 100%);
            border: 1px solid rgba(106, 68, 242, 0.3);
            border-radius: 16px;
            padding: 30px;
            max-width: 550px;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 60px rgba(106, 68, 242, 0.2);
            animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: white;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-body-custom h3 {
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(106, 68, 242, 0.3);
        }
        .modal-body-custom .close-btn {
            position: absolute;
            top: 15px; right: 20px;
            background: none; border: none;
            color: #bbb; font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-body-custom .close-btn:hover { color: #fff; }

        /* ===== TARJETA DE PEDIDO ===== */
        .pedido-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(106, 68, 242, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        .pedido-card:hover {
            border-color: rgba(106, 68, 242, 0.5);
        }
        .pedido-card .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .pedido-card .pedido-id {
            font-weight: bold;
            color: #FFD700;
            font-size: 15px;
        }
        .pedido-card .pedido-estado {
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .pedido-card .pedido-estado.completado {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        .pedido-card .pedido-estado.pendiente {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }
        .pedido-card .pedido-estado.cancelado {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        .pedido-card .pedido-detalle {
            display: flex;
            justify-content: space-between;
            color: #bbb;
            font-size: 13px;
        }
        .pedido-card .pedido-total {
            color: #6A44F2;
            font-weight: bold;
            font-size: 15px;
        }
        .sin-pedidos {
            text-align: center;
            color: #bbb;
            padding: 30px 0;
            font-size: 14px;
        }

        /* ===== TARJETA INFO USUARIO ===== */
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        .info-item:last-child { border-bottom: none; }
        .info-item .info-label { color: #bbb; font-size: 14px; }
        .info-item .info-value { 
            color: #fff; 
            font-weight: 600; 
            font-size: 14px;
        }
        .info-item .info-value.highlight { color: #FFD700; }

        /* ===== BOTONES TABLA ===== */
        .btn-ver-pedidos, .btn-ver-info {
            padding: 5px 14px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-ver-pedidos {
            background: linear-gradient(135deg, #6A44F2, #3C308C);
            color: white;
        }
        .btn-ver-pedidos:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(106, 68, 242, 0.3);
        }
        .btn-ver-info {
            background: rgba(255, 215, 0, 0.15);
            color: #FFD700;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .btn-ver-info:hover {
            background: rgba(255, 215, 0, 0.25);
            transform: translateY(-1px);
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            padding: 30px;
            color: #bbb;
        }

        /* ================================================ */
        /*  TABLA USUARIOS ‚Äî TEMA OSCURO MODERNO            */
        /* ================================================ */

        /* Contenedor principal */
        .gestion-usuarios-panel {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1f4f 100%) !important;
            border: 1px solid rgba(106, 68, 242, 0.25) !important;
            border-radius: 16px !important;
            padding: 30px 35px !important;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.35), 0 0 40px rgba(106, 68, 242, 0.08) !important;
        }

        /* T√≠tulo */
        .gestion-usuarios-panel h1 {
            color: #fff !important;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(106, 68, 242, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .gestion-usuarios-panel h1::before {
            content: 'üë•';
            font-size: 26px;
        }

        /* Tabla base ‚Äî reset de Bootstrap */
        .gestion-usuarios-panel .table {
            --bs-table-bg: transparent !important;
            --bs-table-striped-bg: rgba(106, 68, 242, 0.06) !important;
            --bs-table-hover-bg: rgba(106, 68, 242, 0.12) !important;
            --bs-table-border-color: rgba(106, 68, 242, 0.12) !important;
            --bs-table-color: #d4d0f0 !important;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 0;
        }

        /* Cabecera */
        .gestion-usuarios-panel .table thead {
            background: rgba(106, 68, 242, 0.15) !important;
        }
        .gestion-usuarios-panel .table thead th {
            background: transparent !important;
            color: #B5B3F2 !important;
            font-family: 'Horizon', sans-serif;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 14px 16px !important;
            border-bottom: 2px solid rgba(106, 68, 242, 0.25) !important;
            white-space: nowrap;
        }
        .gestion-usuarios-panel .table thead th:first-child {
            border-radius: 10px 0 0 0;
        }
        .gestion-usuarios-panel .table thead th:last-child {
            border-radius: 0 10px 0 0;
        }

        /* Celdas del body */
        .gestion-usuarios-panel .table tbody td {
            background: transparent !important;
            color: #d4d0f0 !important;
            padding: 13px 16px !important;
            vertical-align: middle !important;
            border-bottom: 1px solid rgba(106, 68, 242, 0.08) !important;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        /* Filas hover */
        .gestion-usuarios-panel .table tbody tr {
            transition: all 0.2s ease;
        }
        .gestion-usuarios-panel .table tbody tr:hover td {
            background: rgba(106, 68, 242, 0.1) !important;
        }

        /* √öltima fila sin borde inferior */
        .gestion-usuarios-panel .table tbody tr:last-child td {
            border-bottom: none !important;
        }

        /* Badge Admin */
        .badge-admin {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .badge-admin.si {
            background: rgba(46, 204, 113, 0.18);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.25);
        }
        .badge-admin.no {
            background: rgba(255, 255, 255, 0.06);
            color: #999;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Switch toggle personalizado */
        .gestion-usuarios-panel .form-check-input {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(106, 68, 242, 0.3) !important;
            cursor: pointer;
            width: 2.5em;
            height: 1.25em;
        }
        .gestion-usuarios-panel .form-check-input:checked {
            background-color: #6A44F2 !important;
            border-color: #6A44F2 !important;
        }
        .gestion-usuarios-panel .form-check-input:focus {
            box-shadow: 0 0 0 0.2rem rgba(106, 68, 242, 0.25) !important;
        }
        .gestion-usuarios-panel .form-check-label {
            color: #bbb !important;
            font-size: 13px;
            margin-left: 4px;
        }

        /* Bot√≥n eliminar oscuro */
        .btn-eliminar-usuario {
            background: rgba(231, 76, 60, 0.15) !important;
            color: #e74c3c !important;
            border: 1px solid rgba(231, 76, 60, 0.3) !important;
            border-radius: 6px !important;
            padding: 5px 14px !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
        }
        .btn-eliminar-usuario:hover {
            background: rgba(231, 76, 60, 0.3) !important;
            border-color: rgba(231, 76, 60, 0.5) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
        }
        .btn-eliminar-usuario:disabled {
            opacity: 0.4 !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* ===== MODAL ELIMINACI√ìN (Bootstrap) ‚Äî Tema oscuro ===== */
        .modal-content {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1f4f 100%) !important;
            border: 1px solid rgba(106, 68, 242, 0.3) !important;
            border-radius: 16px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4) !important;
            color: #d4d0f0 !important;
        }
        .modal-header {
            border-bottom: 1px solid rgba(106, 68, 242, 0.2) !important;
            padding: 20px 24px !important;
        }
        .modal-header .modal-title {
            color: #fff !important;
            font-weight: 700;
            font-size: 18px;
        }
        .modal-header .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%) !important;
            opacity: 0.6;
        }
        .modal-header .btn-close:hover {
            opacity: 1;
        }
        .modal-body {
            padding: 20px 24px !important;
            color: #bbb !important;
            font-size: 14px;
            line-height: 1.6;
        }
        .modal-body p {
            color: #ccc !important;
        }
        .modal-footer {
            border-top: 1px solid rgba(106, 68, 242, 0.15) !important;
            padding: 16px 24px !important;
            gap: 10px;
        }
        .modal-footer .btn-secondary {
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #bbb !important;
            border-radius: 8px !important;
            font-weight: 600;
            transition: all 0.2s;
        }
        .modal-footer .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            color: #fff !important;
        }
        .modal-footer .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
            border: none !important;
            border-radius: 8px !important;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.25);
            transition: all 0.2s;
        }
        .modal-footer .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4) !important;
            transform: translateY(-1px);
        }
        .modal-backdrop.show {
            backdrop-filter: blur(3px);
        }

        /* ===== EMAIL HIGHLIGHT ===== */
        .email-cell {
            color: #8b82d4 !important;
            font-size: 13px;
        }

        /* ===== BARRA DE FILTROS ===== */
        .filtros-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 24px;
            padding: 18px 20px;
            background: rgba(106, 68, 242, 0.06);
            border: 1px solid rgba(106, 68, 242, 0.15);
            border-radius: 12px;
        }
        .filtros-bar .filtro-label {
            display: flex;
            align-items: center;
            color: #8b82d4;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-right: 6px;
            white-space: nowrap;
        }
        .filtro-chip {
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid rgba(106, 68, 242, 0.25);
            background: rgba(255, 255, 255, 0.04);
            color: #bbb;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            user-select: none;
        }
        .filtro-chip:hover {
            background: rgba(106, 68, 242, 0.12);
            border-color: rgba(106, 68, 242, 0.4);
            color: #d4d0f0;
        }
        .filtro-chip.active {
            background: linear-gradient(135deg, #6A44F2, #3C308C);
            border-color: #6A44F2;
            color: #fff;
            box-shadow: 0 4px 14px rgba(106, 68, 242, 0.3);
        }
        .filtro-chip .chip-count {
            display: inline-block;
            margin-left: 6px;
            background: rgba(255, 255, 255, 0.15);
            padding: 1px 7px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }
        .filtro-chip.active .chip-count {
            background: rgba(255, 255, 255, 0.25);
        }
        .filtros-sin-resultados {
            text-align: center;
            color: #888;
            padding: 30px 0;
            font-size: 14px;
            display: none;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 992px) {
            .gestion-usuarios-panel {
                padding: 20px 16px !important;
            }
            .gestion-usuarios-panel .table thead th,
            .gestion-usuarios-panel .table tbody td {
                padding: 10px 8px !important;
                font-size: 12px;
            }
            .btn-ver-pedidos, .btn-ver-info, .btn-eliminar-usuario {
                padding: 4px 10px !important;
                font-size: 11px !important;
            }
        }
    </style>
</head>
<body>
    <header>
        {% include 'navbar.html' %}
    </header>

    <!-- MODAL PEDIDOS -->
    <div class="modal-overlay-custom" id="modalPedidos" onclick="if(event.target===this)cerrarModalPedidos()">
        <div class="modal-body-custom" style="position:relative;">
            <button class="close-btn" onclick="cerrarModalPedidos()">&times;</button>
            <h3 id="modalPedidosTitulo">üì¶ Pedidos</h3>
            <div id="modalPedidosContenido">
                <div class="loading-spinner">Cargando...</div>
            </div>
        </div>
    </div>

    <!-- MODAL INFO -->
    <div class="modal-overlay-custom" id="modalInfo" onclick="if(event.target===this)cerrarModalInfo()">
        <div class="modal-body-custom" style="position:relative;">
            <button class="close-btn" onclick="cerrarModalInfo()">&times;</button>
            <h3 id="modalInfoTitulo">‚ÑπÔ∏è Informaci√≥n</h3>
            <div id="modalInfoContenido">
                <div class="loading-spinner">Cargando...</div>
            </div>
        </div>
    </div>

    <main>
        <div class="form-container table-container gestion-usuarios-panel">
    <!-- FILTROS -->
    <div class="filtros-bar">
        <span class="filtro-label">üîç Filtrar:</span>
        <button class="filtro-chip active" data-filtro="todos" onclick="aplicarFiltro('todos', this)">Todos <span class="chip-count" id="count-todos">0</span></button>
        <button class="filtro-chip" data-filtro="con-pedidos" onclick="aplicarFiltro('con-pedidos', this)">Con pedidos <span class="chip-count" id="count-con-pedidos">0</span></button>
        <button class="filtro-chip" data-filtro="sin-pedidos" onclick="aplicarFiltro('sin-pedidos', this)">Sin pedidos <span class="chip-count" id="count-sin-pedidos">0</span></button>
        <button class="filtro-chip" data-filtro="admins" onclick="aplicarFiltro('admins', this)">Administradores <span class="chip-count" id="count-admins">0</span></button>
        <button class="filtro-chip" data-filtro="comunes" onclick="aplicarFiltro('comunes', this)">Usuarios <span class="chip-count" id="count-comunes">0</span></button>
    </div>

    <h1>Listado de Usuarios</h1>
    <div class="filtros-sin-resultados" id="sinResultadosFiltro">No se encontraron usuarios con este filtro.</div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Email</th>
                <th>Administrador</th>
                <th>Pedidos</th>
                <th>Info</th>
                <th>Modificar</th>
                <th>Eliminar</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
            <tr data-user-id="{{ usuario[0] }}" data-is-admin="{{ '1' if usuario[4] else '0' }}" data-has-pedidos="pending">
                <td>{{ usuario[1] }}</td>
                <td>{{ usuario[2] }}</td>
                <td class="email-cell">{{ usuario[3] }}</td>
                <td>
                    {% if usuario[4] %}
                        <span class="badge-admin si">Admin</span>
                    {% else %}
                        <span class="badge-admin no">Usuario</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn-ver-pedidos" onclick="verPedidos({{ usuario[0] }}, '{{ usuario[1] }} {{ usuario[2] }}')">
                        üì¶ Ver pedidos
                    </button>
                </td>
                <td>
                    <button class="btn-ver-info" onclick="verInfo({{ usuario[0] }}, '{{ usuario[1] }} {{ usuario[2] }}')">
                        ‚ÑπÔ∏è Info
                    </button>
                </td>
                <td class="text-end">
                    <div class="form-check form-switch">
                        {% if usuario[0] == session.get('usuario_id') %}
                            <input class="form-check-input" type="checkbox" id="toggle{{ usuario[0] }}" {% if usuario[4] %}checked{% endif %} disabled title="No puedes cambiar tu propio rol mientras est√°s logueado">
                        {% else %}
                            <input class="form-check-input" type="checkbox" id="toggle{{ usuario[0] }}" {% if usuario[4] %}checked{% endif %} onchange="toggleAdmin('{{ usuario[0] }}')">
                        {% endif %}
                        <label class="form-check-label" for="toggle{{ usuario[0] }}">Admin</label>
                    </div>
                </td>
                <td class="text-end">
                    {% if usuario[0] == session.get('usuario_id') %}
                        <button type="button" class="btn-eliminar-usuario" disabled title="No puedes eliminar tu propia cuenta mientras est√°s logueado">Eliminar</button>
                    {% else %}
                        <button type="button" class="btn-eliminar-usuario" data-bs-toggle="modal" data-bs-target="#confirmarEliminacionModal{{ usuario[0] }}">Eliminar</button>
                    {% endif %}
                    <div class="modal fade" id="confirmarEliminacionModal{{ usuario[0] }}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5">Advertencia...</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body"> 
                                    <p>¬øEst√°s seguro que deseas eliminar a {{ usuario[1] }}? </p>
                                    <p>Esta acci√≥n no puede deshacerse.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salir</button>
                                    <button type="button" class="btn btn-danger" onclick="eliminarUsuario('{{ usuario[0] }}')">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
    </main>

    <script>
        function mostrarNotificacion(mensaje, esError = false) {
            const notif = document.createElement('div');
            notif.className = 'notificacion' + (esError ? ' error' : '');
            notif.textContent = mensaje;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // ===== VER PEDIDOS =====
        function verPedidos(userId, nombre) {
            document.getElementById('modalPedidosTitulo').textContent = 'üì¶ Pedidos de ' + nombre;
            document.getElementById('modalPedidosContenido').innerHTML = '<div class="loading-spinner">Cargando...</div>';
            document.getElementById('modalPedidos').classList.add('active');

            fetch('/api/usuarios/' + userId + '/pedidos')
                .then(r => r.json())
                .then(data => {
                    if (data.ok && data.pedidos.length > 0) {
                        let html = '';
                        data.pedidos.forEach(p => {
                            const estadoClase = p.estado === 'completado' ? 'completado' : 
                                                p.estado === 'pendiente' ? 'pendiente' : 'cancelado';
                            const estadoTexto = p.estado === 'completado' ? '‚úÖ Completado' : 
                                                p.estado === 'pendiente' ? '‚è≥ Pendiente' : '‚ùå Cancelado';
                            html += `
                                <div class="pedido-card">
                                    <div class="pedido-header">
                                        <span class="pedido-id">Pedido #${p.id}</span>
                                        <span class="pedido-estado ${estadoClase}">${estadoTexto}</span>
                                    </div>
                                    <div class="pedido-detalle">
                                        <span>üìÖ ${p.fecha}</span>
                                        <span class="pedido-total">$${p.total.toLocaleString('es-AR')}</span>
                                    </div>
                                </div>
                            `;
                        });
                        document.getElementById('modalPedidosContenido').innerHTML = html;
                    } else {
                        document.getElementById('modalPedidosContenido').innerHTML = 
                            '<div class="sin-pedidos">Este usuario no tiene pedidos registrados.</div>';
                    }
                })
                .catch(() => {
                    document.getElementById('modalPedidosContenido').innerHTML = 
                        '<div class="sin-pedidos" style="color:#e74c3c;">Error al cargar pedidos.</div>';
                });
        }
        function cerrarModalPedidos() {
            document.getElementById('modalPedidos').classList.remove('active');
        }

        // ===== VER INFO =====
        function verInfo(userId, nombre) {
            document.getElementById('modalInfoTitulo').textContent = '‚ÑπÔ∏è Informaci√≥n de ' + nombre;
            document.getElementById('modalInfoContenido').innerHTML = '<div class="loading-spinner">Cargando...</div>';
            document.getElementById('modalInfo').classList.add('active');

            fetch('/api/usuarios/' + userId + '/info')
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        const i = data.info;
                        document.getElementById('modalInfoContenido').innerHTML = `
                            <div class="info-item">
                                <span class="info-label">üìÖ Fecha de creaci√≥n</span>
                                <span class="info-value">${i.fecha_creacion}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üïê √öltimo acceso</span>
                                <span class="info-value">${i.ultimo_acceso}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üì¶ Total de pedidos</span>
                                <span class="info-value highlight">${i.cantidad_pedidos}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üí∞ Monto total gastado</span>
                                <span class="info-value highlight">$${i.monto_total.toLocaleString('es-AR')}</span>
                            </div>
                        `;
                    }
                })
                .catch(() => {
                    document.getElementById('modalInfoContenido').innerHTML = 
                        '<div class="sin-pedidos" style="color:#e74c3c;">Error al cargar informaci√≥n.</div>';
                });
        }
        function cerrarModalInfo() {
            document.getElementById('modalInfo').classList.remove('active');
        }

        // ===== FILTROS =====
        let filtroActual = 'todos';

        function aplicarFiltro(tipo, btnEl) {
            filtroActual = tipo;
            document.querySelectorAll('.filtro-chip').forEach(c => c.classList.remove('active'));
            btnEl.classList.add('active');

            const filas = document.querySelectorAll('table tbody tr[data-user-id]');
            let visibles = 0;
            filas.forEach(fila => {
                const isAdmin = fila.getAttribute('data-is-admin') === '1';
                const hasPedidos = fila.getAttribute('data-has-pedidos') === '1';
                let mostrar = true;

                if (tipo === 'admins') mostrar = isAdmin;
                else if (tipo === 'comunes') mostrar = !isAdmin;
                else if (tipo === 'con-pedidos') mostrar = hasPedidos;
                else if (tipo === 'sin-pedidos') mostrar = !hasPedidos;

                fila.style.display = mostrar ? '' : 'none';
                if (mostrar) visibles++;
            });

            document.getElementById('sinResultadosFiltro').style.display = visibles === 0 ? 'block' : 'none';
        }

        function actualizarContadores() {
            const filas = document.querySelectorAll('table tbody tr[data-user-id]');
            let total = 0, admins = 0, comunes = 0, conPedidos = 0, sinPedidos = 0;
            filas.forEach(f => {
                total++;
                if (f.getAttribute('data-is-admin') === '1') admins++; else comunes++;
                if (f.getAttribute('data-has-pedidos') === '1') conPedidos++; else sinPedidos++;
            });
            document.getElementById('count-todos').textContent = total;
            document.getElementById('count-admins').textContent = admins;
            document.getElementById('count-comunes').textContent = comunes;
            document.getElementById('count-con-pedidos').textContent = conPedidos;
            document.getElementById('count-sin-pedidos').textContent = sinPedidos;
        }

        // Precargar dato de pedidos por usuario usando la API existente
        (function precargarPedidos() {
            const filas = document.querySelectorAll('table tbody tr[data-user-id]');
            let pendientes = filas.length;
            if (pendientes === 0) { actualizarContadores(); return; }

            filas.forEach(fila => {
                const uid = fila.getAttribute('data-user-id');
                fetch('/api/usuarios/' + uid + '/info')
                    .then(r => r.json())
                    .then(data => {
                        if (data.ok) {
                            fila.setAttribute('data-has-pedidos', data.info.cantidad_pedidos > 0 ? '1' : '0');
                        } else {
                            fila.setAttribute('data-has-pedidos', '0');
                        }
                    })
                    .catch(() => fila.setAttribute('data-has-pedidos', '0'))
                    .finally(() => {
                        pendientes--;
                        if (pendientes === 0) actualizarContadores();
                    });
            });
        })();

        // ===== CAMBIAR ROLES =====
        function toggleAdmin(userId) {
            var checkbox = document.getElementById("toggle" + userId);
            var isChecked = checkbox.checked;
            fetch("/actualizar_rol/" + userId, {
                method: "POST",
                body: JSON.stringify({ isAdmin: isChecked }),
                headers: { "Content-Type": "application/json" }
            })
            .then(async response => {
                if (response.ok) {
                    location.reload();
                } else {
                    const data = await response.json().catch(()=>null);
                    const msg = data && data.error ? data.error : "Error al actualizar el rol del usuario";
                    mostrarNotificacion('‚ùå ' + msg, true);
                    checkbox.checked = !isChecked;
                }
            })
            .catch(error => {
                mostrarNotificacion('‚ùå Error de red al actualizar rol', true);
                checkbox.checked = !isChecked;
            });
        }

        // ===== ELIMINAR USUARIOS =====
        function eliminarUsuario(userId) {
            fetch("/eliminar/" + userId, { method: "POST" })
            .then(async response => {
                if (response.ok) {
                    mostrarNotificacion('‚úì Usuario eliminado correctamente');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const data = await response.json().catch(()=>null);
                    const msg = data && data.error ? data.error : "Error al eliminar el usuario";
                    mostrarNotificacion('‚ùå ' + msg, true);
                }
            })
            .catch(error => {
                mostrarNotificacion('‚ùå Error de red al eliminar usuario', true);
            });
        }
    </script>
    {% include 'footer.html' %}
</body>
</html>