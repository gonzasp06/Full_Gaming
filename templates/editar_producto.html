<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FullGaming</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo_solo.png') }}">
    <!--Estilo CSS-->
    <link rel="stylesheet"  href="{{ url_for('static', filename='css/index.css') }}">
    <!-- Vinculacion con Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Scripts de Bootstrap and jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</head>
<body>
    <header>
        {% include 'navbar.html' %} <!--incluye el navabar.html-->
    </header>

    <main>
        <div class="container py-6 form-container">
        <h1 class="text-center">Editar Producto</h1>

        {% set p_id = producto.id if producto is mapping else producto[0] %}
        {% set p_nombre = producto.nombre if producto is mapping else producto[1] %}
        {% set p_desc = producto.descripcion if producto is mapping else producto[2] %}
        {% set p_cat = producto.categoria if producto is mapping else producto[3] %}
        {% set p_precio = producto.precio if producto is mapping else producto[4] %}
        {% set p_cant = producto.cantidad if producto is mapping else producto[5] %}
        {% set p_foto = producto.foto if producto is mapping else producto[6] %}
        {% set p_costo = producto.costo if producto is mapping else (producto[7] if producto|length > 7 else '') %}
        {% set p_marca = producto.nombre_marca if producto is mapping else '' %}

        <form id="formularioProducto" action="/actualizar_producto/{{ p_id }}" method="POST" enctype="multipart/form-data">
            
            <div class="form-group">
                <label for="nombre" class="form-label">Nombre:</label>
                <input type="text" id="nombre" name="nombre" class="form-control" value="{{ p_nombre }}">
            </div>

            <div class="form-group">
                <label for="descripcion" class="form-label">Descripci√≥n:</label>
                <div id="descripcion-editor" style="height:150px;"></div>
                <input type="hidden" id="descripcion" name="descripcion" value="{{ p_desc }}">
            </div>

            <div class="form-group">
                <label for="categoria" class="form-label">Categoria:</label>
                <select id="categoria" name="categoria" class="form-control"> 
                    <option value="Teclados">Teclados</option>
                    <option value="Mouse">Mouse</option>
                    <option value="Audio">Audio</option>
                    <option value="Joysticks">Joysticks</option>
                    <option value="Otros">Otros</option>
                </select>
            </div>

            <div class="form-group">
                <label for="marca" class="form-label">Marca: <span style="color:#888; font-size:12px;">(opcional - se detecta del nombre)</span></label>
                <input type="text" id="marca" name="marca" class="form-control" list="marcasSugeridas" placeholder="Ej: Logitech, Razer, GameSir" autocomplete="off" value="{{ p_marca or '' }}">
                <datalist id="marcasSugeridas">
                    {% if marcas %}
                        {% for marca in marcas %}
                        <option value="{{ marca.nombre }}">
                        {% endfor %}
                    {% else %}
                        <!-- Marcas por defecto si no hay en BD -->
                        <option value="Razer">
                        <option value="ASUS">
                        <option value="Logitech">
                        <option value="Redragon">
                        <option value="GameSir">
                        <option value="Corsair">
                        <option value="HyperX">
                        <option value="SteelSeries">
                        <option value="Cooler Master">
                        <option value="MSI">
                    {% endif %}
                </datalist>
                <div id="marcaSugerida" style="display:none; margin-top:8px; padding:10px 14px; background:rgba(46,204,113,0.15); border:1px solid rgba(46,204,113,0.3); border-radius:8px; font-size:13px; color:#2ecc71;">
                    <span>üí° Marca detectada: <strong id="marcaDetectadaTexto"></strong></span>
                    <button type="button" onclick="usarMarcaSugerida()" style="margin-left:12px; background:#2ecc71; color:white; border:none; padding:5px 12px; border-radius:5px; font-size:12px; cursor:pointer;">Usar esta</button>
                </div>
            </div>

            <div class="form-group">
                <label for="precio" class="form-label">Precio:</label>
                <input type="text" id="precio" name="precio" class="form-control" value="{{ p_precio }}">
            </div>

            <div class="form-group">
                <label for="costo" class="form-label">Costo / Inversi√≥n:</label>
                <input type="text" id="costo" name="costo" class="form-control" value="{{ p_costo }}" placeholder="Costo real del producto">
            </div>

            <div class="form-group">
                <label for="cantidad" class="form-label">Cantidad:</label>
                <input type="number" id="cantidad" name="cantidad" class="form-control" value="{{ p_cant }}">
            </div>

            <div class="form-group">
                <label for="foto" class="form-label">Foto nueva (opcional):</label>
                <input type="file" id="foto" name="foto" class="form-control">
            </div>

            <button type="submit" class="btn btn-primary mt-3">Guardar Cambios</button>
        </form>
    </div>
    </main>

    <script>
        // Inicializar Quill y cargar contenido existente
        var quill = new Quill('#descripcion-editor', {
            theme: 'snow',
            modules: {
                clipboard: { matchers: [] },
                toolbar: true
            }
        });

        // Forzar pegado como texto plano (sin fuentes ni estilos externos)
        quill.clipboard.addMatcher(Node.ELEMENT_NODE, function(node, delta) {
            delta.ops = delta.ops.map(op => {
                if (op.insert && typeof op.insert === 'string') {
                    return { insert: op.insert };
                }
                return op;
            });
            return delta;
        });

        quill.clipboard.dangerouslyPasteHTML({{ p_desc|tojson }});

        // Asignar categor√≠a actual
        document.getElementById('categoria').value = "{{ p_cat }}";

        document.getElementById('formularioProducto').addEventListener('submit', function() {
            document.getElementById('descripcion').value = quill.root.innerHTML;
        });

        // ===== DETECCI√ìN AUTOM√ÅTICA DE MARCA =====
        const MARCAS_GAMING = [
            'Razer', 'Logitech', 'Redragon', 'HyperX', 'Corsair', 'SteelSeries',
            'GameSir', 'Trust', 'Genius', '8BitDo', 'Thrustmaster',
            'JBL', 'Sony', 'Sennheiser', 'Audio-Technica', 'Astro', 'Turtle Beach',
            'ASUS', 'Samsung', 'LG', 'AOC', 'BenQ', 'ViewSonic', 'MSI', 'Gigabyte',
            'Dell', 'Acer', 'HP', 'Philips',
            'Xbox', 'Nintendo', 'PowerA', 'PDP', 'SCUF', 'Nacon',
            'AMD', 'Intel', 'NVIDIA', 'EVGA', 'Zotac', 'PNY',
            'Kingston', 'Seagate', 'WD', 'Crucial', 'XPG', 'Adata', 'SanDisk',
            'Thermaltake', 'NZXT', 'Cooler Master', 'be quiet!', 'DeepCool',
            'DXRacer', 'Secretlab', 'AKRacing', 'Cougar'
        ];

        let marcaDetectadaActual = null;

        function detectarMarcaDesdeNombre(nombre) {
            const nombreLower = nombre.toLowerCase();
            for (const marca of MARCAS_GAMING) {
                if (nombreLower.includes(marca.toLowerCase())) {
                    return marca;
                }
            }
            return null;
        }

        function verificarMarcaEnNombre() {
            const nombre = document.getElementById('nombre').value;
            const marcaInput = document.getElementById('marca');
            const sugerenciaDiv = document.getElementById('marcaSugerida');
            const marcaTexto = document.getElementById('marcaDetectadaTexto');
            
            const marcaDetectada = detectarMarcaDesdeNombre(nombre);
            
            if (marcaDetectada && marcaInput.value.trim() === '') {
                marcaDetectadaActual = marcaDetectada;
                marcaTexto.textContent = marcaDetectada;
                sugerenciaDiv.style.display = 'block';
            } else {
                sugerenciaDiv.style.display = 'none';
            }
        }

        function usarMarcaSugerida() {
            if (marcaDetectadaActual) {
                document.getElementById('marca').value = marcaDetectadaActual;
                document.getElementById('marcaSugerida').style.display = 'none';
            }
        }

        document.getElementById('nombre').addEventListener('input', verificarMarcaEnNombre);
        document.getElementById('marca').addEventListener('input', function() {
            if (this.value.trim() !== '') {
                document.getElementById('marcaSugerida').style.display = 'none';
            }
        });

        // Detectar marca al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', verificarMarcaEnNombre);
    </script>

    {% include 'footer.html' %} 
</body>
</html>