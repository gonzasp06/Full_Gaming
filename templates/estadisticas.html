<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - FullGaming</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo_solo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            font-family: 'Horizon', sans-serif;
        }

        .estadisticas-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            box-sizing: border-box;
        }

        .estadisticas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .estadisticas-header h1 {
            margin: 0;
            color: #333;
            font-size: 28px;
        }

        .estadisticas-header .fecha {
            color: #999;
            font-size: 12px;
        }

        .resumen-tarjetas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .tarjeta {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .tarjeta:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tarjeta-titulo {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .tarjeta-valor {
            color: #2c3e50;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .tarjeta-subtexto {
            color: #999;
            font-size: 11px;
        }

        .tarjeta.ventas {
            border-left: 4px solid #27ae60;
        }

        .tarjeta.pedidos {
            border-left: 4px solid #3498db;
        }

        .tarjeta.usuarios {
            border-left: 4px solid #e74c3c;
        }

        .tarjeta.ticket {
            border-left: 4px solid #f39c12;
        }

        .graficos-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .grafico-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            aspect-ratio: 1 / 1.2;
            min-width: 0;
            overflow: hidden;
        }

        .grafico-container canvas {
            width: 100% !important;
            height: 100% !important;
            flex: 1;
        }

        .grafico-titulo {
            color: #333;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 8px;
            flex-shrink: 0;
        }

        .tabla-section {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .tabla-titulo {
            color: #333;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .tabla-responsiva {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
        }

        .tabla-responsiva th {
            background-color: #34495e;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .tabla-responsiva td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }

        .tabla-responsiva tr:hover {
            background-color: #f8f9fa;
        }

        .tabla-responsiva .monto {
            color: #27ae60;
            font-weight: bold;
        }

        .error-mensaje {
            background-color: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 4px solid #f39c12;
            border-top: 4px solid transparent;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dos-columnas {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            width: 100%;
            margin: 0 auto 30px;
            max-width: 100%;
        }

        @media (max-width: 1024px) {
            .dos-columnas {
                gap: 25px;
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .dos-columnas {
                gap: 20px;
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dos-columnas {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .grafico-container {
                aspect-ratio: 1 / 1.1;
            }

            .graficos-section {
                grid-template-columns: 1fr;
            }

            .resumen-tarjetas {
                grid-template-columns: 1fr 1fr;
            }

            .estadisticas-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .dos-columnas {
                gap: 15px;
            }

            .grafico-container {
                aspect-ratio: 1 / 1.05;
                padding: 15px;
            }

            .grafico-titulo {
                font-size: 12px;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Importar navbar -->
    {% include 'navbar.html' %}

    <div class="estadisticas-container">
        {% if error %}
            <div class="error-mensaje">
                <strong>Error:</strong> {{ error }}
            </div>
        {% endif %}

        {% if resumen %}
            <div class="estadisticas-header">
                <h1>üìä Dashboard de Estad√≠sticas</h1>
                <div>
                    <div class="fecha" id="fecha-actualizacion">√öltima actualizaci√≥n: {{ resumen.fecha_generacion }}</div>
                    <button id="btn-refrescar" style="margin-top: 10px; padding: 8px 16px; background: #6A44F2; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üîÑ Refrescar Datos</button>
                </div>
            </div>

            <!-- TARJETAS DE RESUMEN GENERAL -->
            <div class="resumen-tarjetas">
                <div class="tarjeta ventas">
                    <div class="tarjeta-titulo">Ventas Totales</div>
                    <div class="tarjeta-valor">${{ "{:,.0f}".format(resumen.ventas_totales) }}</div>
                    <div class="tarjeta-subtexto">Desde el inicio del negocio</div>
                </div>

                <div class="tarjeta pedidos">
                    <div class="tarjeta-titulo">Total de Pedidos</div>
                    <div class="tarjeta-valor">{{ resumen.cantidad_pedidos }}</div>
                    <div class="tarjeta-subtexto">Pedidos completados</div>
                </div>

                <div class="tarjeta ticket">
                    <div class="tarjeta-titulo">Ticket Promedio</div>
                    <div class="tarjeta-valor">${{ "{:,.0f}".format(resumen.ticket_promedio) }}</div>
                    <div class="tarjeta-subtexto">Valor promedio por pedido</div>
                </div>

                <div class="tarjeta usuarios">
                    <div class="tarjeta-titulo">Total de Usuarios</div>
                    <div class="tarjeta-valor">{{ resumen.cantidad_usuarios }}</div>
                    <div class="tarjeta-subtexto">Usuarios registrados</div>
                </div>

                <div class="tarjeta ventas">
                    <div class="tarjeta-titulo">Ingresos √öltimos 30 d√≠as</div>
                    <div class="tarjeta-valor">${{ "{:,.0f}".format(resumen.ingresos_mes) }}</div>
                    <div class="tarjeta-subtexto">Este mes</div>
                </div>

                <div class="tarjeta usuarios">
                    <div class="tarjeta-titulo">Usuarios Nuevos</div>
                    <div class="tarjeta-valor">{{ resumen.nuevos_usuarios }}</div>
                    <div class="tarjeta-subtexto">√öltimos 30 d√≠as</div>
                </div>
            </div>

            <!-- GR√ÅFICOS -->
            <div class="dos-columnas">
                <!-- Gr√°fico: Top 5 Productos -->
                <div class="grafico-container">
                    <div class="grafico-titulo">üèÜ Top 5 Productos M√°s Vendidos</div>
                    <canvas id="grafico-productos"></canvas>
                </div>

                <!-- Gr√°fico: Estad√≠sticas por Categor√≠a -->
                <div class="grafico-container">
                    <div class="grafico-titulo">üìÅ Ingresos por Categor√≠a</div>
                    <canvas id="grafico-categorias"></canvas>
                </div>
            </div>

            <!-- NUEVOS GR√ÅFICOS -->
            <div class="dos-columnas">
                <!-- Gr√°fico: Ingresos vs Egresos -->
                <div class="grafico-container">
                    <div class="grafico-titulo">üí∞ Ingresos vs Egresos</div>
                    <canvas id="grafico-ingresos-egresos"></canvas>
                </div>

                <!-- Gr√°fico: Evoluci√≥n de Ingresos -->
                <div class="grafico-container">
                    <div class="grafico-titulo">üìà Evoluci√≥n de Ingresos</div>
                    <canvas id="grafico-evolucion"></canvas>
                </div>
            </div>

            <!-- TABLAS DE INFORMACI√ìN DETALLADA -->
            
            <!-- Tabla: Productos M√°s Vendidos -->
            <div class="tabla-section">
                <div class="tabla-titulo">üõçÔ∏è Productos M√°s Vendidos</div>
                <table class="tabla-responsiva">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad Vendida</th>
                            <th>Precio Unitario</th>
                            <th>Ingresos Generados</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in resumen.productos_mas_vendidos %}
                        <tr>
                            <td>{{ producto.nombre }}</td>
                            <td>{{ producto.cantidad_vendida }} unidades</td>
                            <td>${{ "{:,.0f}".format(producto.precio) }}</td>
                            <td class="monto">${{ "{:,.0f}".format(producto.ingresos) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">
                                No hay productos vendidos a√∫n
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Tabla: Usuarios M√°s Activos -->
            <div class="tabla-section">
                <div class="tabla-titulo">üë• Clientes M√°s Activos</div>
                <table class="tabla-responsiva">
                    <thead>
                        <tr>
                            <th>Nombre y Apellido</th>
                            <th>Email</th>
                            <th>Cantidad de Pedidos</th>
                            <th>Total Gastado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usuario in resumen.usuarios_mas_activos %}
                        <tr>
                            <td>{{ usuario.nombre }} {{ usuario.apellido }}</td>
                            <td>{{ usuario.email }}</td>
                            <td>{{ usuario.cantidad_pedidos }}</td>
                            <td class="monto">${{ "{:,.0f}".format(usuario.total_gastado) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">
                                No hay compras registradas a√∫n
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Tabla: Productos con Bajo Stock -->
            <div class="tabla-section">
                <div class="tabla-titulo">‚ö†Ô∏è Productos con Bajo Stock</div>
                <table class="tabla-responsiva">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Stock Actual</th>
                            <th>Precio Unitario</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in resumen.productos_bajo_stock %}
                        <tr>
                            <td>{{ producto.nombre }}</td>
                            <td>{{ producto.categoria }}</td>
                            <td style="color: #e74c3c; font-weight: bold;">{{ producto.stock }} unidades</td>
                            <td>${{ "{:,.0f}".format(producto.precio) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">
                                ‚úÖ Todos los productos tienen stock disponible
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% else %}
            <div class="loading">
                <div class="spinner"></div>
                <p>Cargando estad√≠sticas...</p>
            </div>
        {% endif %}
    </div>

    <script>
        // Auto-refresh de datos cada 30 segundos
        setInterval(function() {
            actualizarEstadisticas();
        }, 30000);

        function actualizarEstadisticas() {
            fetch('/api/estadisticas/resumen')
                .then(response => response.json())
                .then(data => {
                    // Actualizar ventas totales
                    const ventasEl = document.querySelector('.tarjeta.ventas .tarjeta-valor');  
                    if (ventasEl) {
                        ventasEl.textContent = '$' + data.ventas_totales.toLocaleString('es-AR');
                    }
                    
                    // Actualizar cantidad de pedidos
                    const pedidosEl = document.querySelectorAll('.tarjeta.pedidos .tarjeta-valor')[0];
                    if (pedidosEl) {
                        pedidosEl.textContent = data.cantidad_pedidos;
                    }
                    
                    // Actualizar fecha
                    const fechaEl = document.getElementById('fecha-actualizacion');
                    if (fechaEl) {
                        const ahora = new Date().toLocaleString('es-AR');
                        fechaEl.textContent = '√öltima actualizaci√≥n: ' + ahora;
                    }
                    
                    console.log('Estad√≠sticas actualizadas');
                })
                .catch(error => console.error('Error actualizando estad√≠sticas:', error));
        }

        // Bot√≥n refrescar
        document.getElementById('btn-refrescar').addEventListener('click', function() {
            this.textContent = '‚è≥ Cargando...';
            this.disabled = true;
            
            actualizarEstadisticas();
            
            setTimeout(() => {
                this.textContent = 'üîÑ Refrescar Datos';
                this.disabled = false;
                location.reload();  // Recargar la p√°gina completa
            }, 1000);
        });

        // Datos de los gr√°ficos
        const datosProductos = {
            labels: [
                {% for producto in resumen.productos_mas_vendidos %}
                    "{{ producto.nombre[:30] }}...",
                {% endfor %}
            ],
            datasets: [{
                label: "Unidades Vendidas",
                data: [
                    {% for producto in resumen.productos_mas_vendidos %}
                        {{ producto.cantidad_vendida }},
                    {% endfor %}
                ],
                backgroundColor: [
                    '#3498db',
                    '#2ecc71',
                    '#f39c12',
                    '#e74c3c',
                    '#9b59b6'
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        };

        // Gr√°fico de productos
        const ctxProductos = document.getElementById('grafico-productos');
        if (ctxProductos) {
            new Chart(ctxProductos, {
                type: 'doughnut',
                data: datosProductos,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: 30
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                },
                                boxWidth: 12,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico de categor√≠as
        const datoCategorias = {
            labels: [],
            datasets: [{
                label: "Ingresos ($)",
                data: [],
                backgroundColor: '#3498db',
                borderColor: '#fff',
                borderWidth: 2
            }]
        };

        // Cargar datos de categor√≠as
        fetch('/api/estadisticas/por-categoria')
            .then(response => response.json())
            .then(data => {
                if (data.categorias) {
                    datoCategorias.labels = data.categorias.map(c => c.categoria);
                    datoCategorias.datasets[0].data = data.categorias.map(c => c.ingresos);
                    datoCategorias.datasets[0].backgroundColor = [
                        '#3498db',
                        '#2ecc71',
                        '#f39c12',
                        '#e74c3c',
                        '#9b59b6',
                        '#1abc9c'
                    ];
                    
                    const ctxCategorias = document.getElementById('grafico-categorias');
                    new Chart(ctxCategorias, {
                        type: 'bar',
                        data: datoCategorias,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    bottom: 20
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toLocaleString('es-AR');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Error cargando categor√≠as:', error));

        // =================== GR√ÅFICO: INGRESOS VS EGRESOS ===================
        fetch('/api/estadisticas/ingresos-vs-egresos')
            .then(response => response.json())
            .then(data => {
                if (data.datos && data.datos.length > 0) {
                    const datosBalanceData = {
                        labels: data.datos.map(d => d.mes),
                        datasets: [
                            {
                                label: "Ingresos ($)",
                                data: data.datos.map(d => d.ingresos),
                                backgroundColor: '#2ecc71',
                                borderColor: '#27ae60',
                                borderWidth: 2
                            },
                            {
                                label: "Egresos ($)",
                                data: data.datos.map(d => d.egresos),
                                backgroundColor: '#e74c3c',
                                borderColor: '#c0392b',
                                borderWidth: 2
                            }
                        ]
                    };
                    
                    const ctxBalance = document.getElementById('grafico-ingresos-egresos');
                    new Chart(ctxBalance, {
                        type: 'bar',
                        data: datosBalanceData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    bottom: 20
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 10,
                                        font: { size: 11 },
                                        boxWidth: 12,
                                        usePointStyle: false
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + (value/1000).toFixed(0) + 'k';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Error cargando ingresos vs egresos:', error));

        // =================== GR√ÅFICO: EVOLUCI√ìN DE INGRESOS ===================
        fetch('/api/estadisticas/evolucion-ingresos')
            .then(response => response.json())
            .then(data => {
                if (data.datos && data.datos.length > 0) {
                    const datosEvolucion = {
                        labels: data.datos.map(d => d.mes_corto),
                        datasets: [{
                            label: "Ingresos ($)",
                            data: data.datos.map(d => d.ingresos),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#3498db',
                            tension: 0.3,
                            fill: true
                        }]
                    };
                    
                    const ctxEvolucion = document.getElementById('grafico-evolucion');
                    new Chart(ctxEvolucion, {
                        type: 'line',
                        data: datosEvolucion,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    bottom: 20
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        padding: 10,
                                        font: { size: 11 },
                                        boxWidth: 12,
                                        usePointStyle: true
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + (value/1000).toFixed(0) + 'k';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Error cargando evoluci√≥n de ingresos:', error));
    </script>

    
</body>
</html>
